<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://docbook.org/xml/5.0/rng/docbook.rng" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>
<article xmlns="http://docbook.org/ns/docbook" version="5.0">

	<info>
		
		<title>Improving Pattern Matching Performance in XSLT</title>

		<date>2015-05-03</date>

		<authorgroup>			
			<author>
				<personname>
					<firstname>John</firstname>
					<surname>Lumley</surname>
				</personname>
				<affiliation>
<!--					<jobtitle>Director</jobtitle> -->
					<orgname>jωL Research, Saxonica</orgname>
				</affiliation>
				<!--
				<affiliation>
					<jobtitle>Contributor</jobtitle>
					<orgname>Saxonica</orgname>
				</affiliation>
				-->	
				<address>                
		      <street>6 Raleigh Rise, Portishead</street>
		      <city>Bristol</city>
		      <postcode>BS20 6LA</postcode>
		      <country>United Kingdom</country>
	      </address>
				<email>john@jwlresearch.com</email>
			</author>
			<author>
				<personname>
					<firstname>Michael</firstname>
					<surname>Kay</surname>
				</personname>
				<affiliation>
					<jobtitle>Director</jobtitle>
					<orgname>Saxonica</orgname>
				</affiliation>
				<address>                
					<street>Chiltern Court, 37 St Peter's Avenue</street>
					<city>Reading</city>
					<postcode>RG4 7DH</postcode>
					<country>United Kingdom</country>
				</address>
				<email>mike@saxonica.com</email>
			</author>
		</authorgroup>
		
		<keywordset>
			<keyword>XSLT</keyword>
			<keyword>Pattern matching</keyword>
		</keywordset>
		
		<abstract>
			<para>This paper discusses improving the performance of XSLT programs that use very large
				numbers of similar patterns in their push-mode templates. The experimentation focusses
				around stylesheets used for processing DITA document frameworks, where much of the document
				logical structure is encoded in <code>@class</code> attributes. The processing stylesheets,
				often defined in XSLT1.0, use string-containment tests on these attributes to describe
				push-template applicability. For some cases this can mean a few hundred string tests have to
				be performed for every element node in the input document to determine which template to
				evaluate, which in sometimes means up to 30% of the entire processing time is taken up with
				such pattern matching. This paper examines methods, within XSLT implementations, to
				ameliorate this situation, including using sets of pattern preconditions and
				pre-tokenization of the class-describing attributes. How such optimisation may be configured
				for an XSLT implementation is discussed.</para>
		</abstract>
	</info>

	<sect1>
		<title>Introduction</title>
		<para>XSLT's push mode of processing <biblioref linkend="XSLT"/>, where templates are invoked by
			matching XPath-based patterns that describe conditions on nodes to which they are applicable,
			is one of the really powerful features of that language. It allows very precise declarative
			description of the cases for which a template is considered relevant, and along with a
			well-defined mechanism of priority, and precedence, permits specialisation and overriding of
			'libraries' to encourage significant code reuse. Whilst other features of XSLT are valuable,
			push-mode pattern matching is almost certainly the most important.</para>
		<para>Consequently much effort has been expended on developing XSLT-based processing libraries,
			for many types of XML processing, most notably in 'document engineering', such as DocBook and
			DITA, which use pattern-matching templates extensively. Typically a processing step might
			involve the use of hundreds of templates which have to be 'checked' for applicablity against
			XML nodes that are being processed in a push fashion. One of the challenges for the
			implementor of an XSLT engine is to ensure that for most common cases, this matching process
			is efficient.</para>
		<para linkend="Kay.2005">Various aspects of overall XSLT performance have been studied and
			reported <xref linkend="Kay.2005"/> <xref linkend="Kay.2014"/> including optimization
				rewriting <xref linkend="Kay.2007"/>. In this paper we will examine some cases where, owing
			to the nature of the XML vocabularies being processed and the design of the large XSLT
			processing stylesheets employed, the <emphasis>default matching process</emphasis> in one XSLT
			implementation (Saxon) can be rather expensive, in some cases taking about a third of all the
			transform execution time. We'll discuss possible additions and modifications to the
			pattern-matching techniques to improve performance and show their effects. Some knowledge of
			XSLT/XPath is assumed.</para>
		<para>The paper is organised as follows:</para>
		<itemizedlist>
			<listitem>
				<para>We first describe <quote>push-mode</quote> processing in XSLT and what the process for
					matching template patterns is in detail.</para>
			</listitem>
			<listitem>
				<para>How this process is performed in the Saxon implementation is presented, along with
					some general remarks about the problems of many templates matching predicated generic, as
					opposed to named, elements.</para>
			</listitem>
			<listitem>
				<para>We discuss in detail measurements of the pattern matching performance when processing
					a large sample DITA document.</para>
			</listitem>
			<listitem>
				<para>Possible improvements using sets of <emphasis>common preconditions</emphasis> to
					partition applicable templates are outlined and performance measurements using a variety
					of these tactics in processing the sample are discussed. </para>
			</listitem>
			<listitem>
				<para>Some other approaches, involving more detailed knowledge of stylesheet expectations
					are discussed briefly.</para>
			</listitem>
			<listitem>
				<para>We speculate on methods to define and introduce such tuning features into an XSLT
					implementation. </para>
			</listitem>
		</itemizedlist>
	</sect1>
	<sect1>
		<title>XSLT push mode</title>
		<para>XSLT's push-mode of processing takes a set of items (usually one or more nodes from the
			input document such as elements, attributes or text) and for each finds a stylesheet template
			declaration whose pattern matches the item (the <quote>context item</quote>) in question.
			Assuming one is found, the body of the template, which can contain both result tree fragments
			and XSLT instructions, is executed to generate a result which is then added to the current
				<emphasis>result tree</emphasis>. This push mode is often exploited highly recursively,
			descending large source input trees to accumulate result transformations, usually as modified
			trees. To understand the problems with large sets of such templates, which is often the case
			in industrial-scale document processing applications, we need to describe more closely what
			this pattern matching process is.</para>
		<para>When processing a candiate item (<quote>context item</quote>) in XSLT via the
				<code>xsl:apply-templates</code> instruction the following is the effective declarative
			procedure:</para>
		<procedure>
			<step>
				<para>All the templates that have <code>@match</code> patterns and operate in the
						<quote>current</quote> mode are considered candidates.</para>
			</step>
			<step>
				<para>For each template so chosen the pattern (which is a modified form of an XPath
					expression) is tested against the context item to determine a boolean value. Only those
					yielding true are considered.</para>
			</step>
			<step>
				<para>The templates with the highest <emphasis>import precedence</emphasis> are retained.
					(Templates in an imported, as opposed to included, stylesheet have precedence lower than
					those in the stylesheet that declares the importation, or any following
						<quote>sibling</quote> imported stylesheets.)</para>
			</step>
			<step>
				<para>From these only those with the highest explicit or implicit priority are considered.
					(Patterns have an implicit priority level calculated based on a 'specificity' formula,
					such that more specific cases (e.g. <code>piece[@class = 'my.class']</code>) have higher
					priority than less specific ones (e.g. <code>piece</code>), and thus supporting a natural
					style for general and specific case programming. Rules can override this by declaring an
					explict priority.)</para>
			</step>
			<step>
				<para>Members of the remaining set of templates are all potential candidates:</para>
				<itemizedlist>
					<listitem>
						<para>If the resulting set is empty, the result is an empty sequence.</para>
					</listitem>
					<listitem>
						<para>If it has just a single template member, then the result of the
								<code>xsl:apply-templates</code> is the (non-error) result of executing the sequence
							constructor of that template with the tested item as the context item.</para>
					</listitem>
					<listitem>
						<para>If the resulting template set has more than one member, then it is an
							implementation choice as to whether a dynamic error is thrown<footnote>
								<para>In XSLT 3.0 this choice can be controlled via stylesheet declarations.</para>
							</footnote>. If not, then the last in <quote>sequence</quote> is chosen and its body
							executed. </para>
					</listitem>
				</itemizedlist>
			</step>
		</procedure>
		<para>What this list doesn't prescribe is how the process is to be implemented. Clearly there
			are a number of possibilities of improving performance, by for example examining candidate
			templates in a suitable order, or pre-classifying subsets of the possible templates. In this
			paper we examine some possibilities which look deeper into the template patterns
			themselves.</para>
	</sect1>
	<sect1>
		<title>Template rules in Saxon</title>
		<para>The algorithm used for matching template patterns in the <link
				xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.saxonica.com">Saxon
				processor</link> has been unchanged for many years <xref linkend="Kay.2005"/>, and works
			well in common cases. In simplified form, it is as follows:</para>
		<para>For template rules whose match pattern identifies the name of the element or attribute to
			be matched (for example <code>match="para"</code>, or <code>match="para[1]"</code>, or
				<code>match="section/para"</code>), the template rule is placed on a list of rules that
			match that specific element or attribute primary QName . Other rules are placed on one of a
			set of generic lists, arranged by type (<code>document-node(), text(), element(*)...</code>) .
			Both the named and generic lists are ordered by "rank", a metric that combines the notions of
			import precedence, template priority, and ordering of rules within the stylesheet.</para>
		<para>When apply-templates is called to process a specific element, Saxon finds the
			highest-ranking matching rule on the list for that specific element name, and also the
			highest-ranking matching rule on the generic list<footnote>
				<para>A template can be referenced from multiple lists when its match conditions contains a
					union of patterns.</para>
			</footnote>. It then chooses whichever of these two has higher rank. The search of the generic
			list is abandoned as soon as it can be established there will not be any matching rule with
			higher rank than a rule found on the specific list. But note that, as we'll see later in our
			example, once a match has been found in either the specific or the generic list, that list
				<emphasis>must still be searched</emphasis> for other matching candidates of similar rank. </para>
		<para>In current versions of Saxon each pattern in the rule chain is examined in turn, to
			determine a boolean matches value. Of course the boolean match processing is processed lazily,
			and in strict sequence, with falsity propagating as quickly as possible, so for example,
			ancestor patterns are only examined if the <code>self::</code> pattern proves true.</para>
		<para>For very many stylesheets, this works well, because most rules specify an element name,
			and there are typically not many rules for each element name, so typically each element that
			is processed is matched against at most half a dozen rules on the specific list for its
			element name; usually the generic list does not need to be considered, because rules on the
			generic list usually have lower rank than rules on the element-specific list.</para>
		<para>The algorithm becomes ineffective, however, when the stylesheet defines very few rules
			that match specific element names, and many rules that are generic. Typically such stylesheets
			match elements according to predicates applied to their attributes, rather than matching them
			by name. A worst-case example of such coding can be found in the DITA-OT family of stylesheets<footnote>
				<para>By contrast the Docbook <link xmlns:xlink="http://www.w3.org/1999/xlink"
						xlink:href="https://github.com/docbook/docbook"/> toolsets, of similar size, use almost
					entirely named element pattern matches.</para>
			</footnote>. Consequently these have therefore been used as a test case for exploring
			improvements to Saxon's pattern matching algorithm. This is even more problematic when the
			stylesheets use a large range of import precedences, as is also true in the example, where as
			we'll see there are some 35 different well-populated ranks. Moreover even the named lists gain
			little as time is dominated totally by checking the unnamed sets.</para>
		<sect2>
			<title>Generic match patterns</title>
			<para>As hinted above, the presence of a lot of patterns of the form <code>*[</code>
				<emphasis>
					<code>predicate</code>
				</emphasis>
				<code>]</code> mean that measures such as indexing patterns on primary element name become
				ineffective. Are there other indexation schemes that can be employed? Clearly if we have
				many match patterns of the form:
				<programlisting>*[@x = 'a']
*[@x = 'b']
*[@x = 'c']</programlisting>
			</para>
			<para>and it is possible to determine statically that these predicates are mutually exclusive,
				then should be possible to construct a hash index whereby we can lookup the value of
				attribute <code>@x</code>, and directly determine which of the patterns applies.</para>
			<para>Unfortunately real life is more complicated. A framework where almost all stylesheet
				template patterns match generic rather than named elements is DITA-OT, where the patterns
				take the form
				<programlisting>*[contains(@x, 'a')]
*[contains(@x, 'b')]
*[contains(@x, 'c')]</programlisting>As
				it happens, in DITA these patterns are designed to be mutually exclusive, so only one of
				them will ever match. But there is no way an optimizer can know that and we cannot thus
				meaningfully generate indices. So if we are going to avoid a sequential search of all the
				patterns, we need a different approach. The rest of this paper examines what this might be,
				after discussing a specific DITA document processing example in detail.</para>
		</sect2>
	</sect1>
	<sect1>
		<title>Processing a DITA document</title>
		<para>The <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://www.dita-ot.org/"
				>DITA-OT framework</link> is a set of mainly XSLT (1.0/2.0) tools for processing DITA
			documents, used extensively in automatic generation of technical documentation. DITA itself
			describes document components in XML trees, using the <code>@class</code> attribute
			extensively, with class membership described through a whitespace-separated set of class
			names. (For a fuller description, see <link xmlns:xlink="http://www.w3.org/1999/xlink"
				xlink:href="http://docs.oasis-open.org/dita/v1.0/archspec/classattdef.html">Class attribute
				syntax</link> in the DITA documentation.) </para>
		<para>One consequence of this is that many of the processing templates within the DITA-OT
			framework describe applicability through a match <quote>is this element in class
					<emphasis>xxx</emphasis>
			</quote>. Unfortunately, within an XSLT1.0 context, where tokenization isn't present, this is
			typically described as a predicated match pattern</para>
		<programlisting>*[contains(@class,' <emphasis>classname</emphasis>  ')]</programlisting>
		<para> (Additional leading and trailing spaces are added to the class attribute value to support
			this generic <code>contains()</code> match.) A little thought would suggest that when a large
			number of such patterns all compete to examine the <code>@class</code> attributes of pretty
			much every element in a document then the pattern-matching process might be very expensive.
			And so it turns out. </para>
		<note>
			<para>This predicated match pattern appears so frequently throughout this paper, that an
				abbreviation <code>@C{ </code>
				<emphasis>
					<code>classname</code>
				</emphasis>
				<code> }</code> will often be used in tables and figures to replace this construct. </para>
		</note>
		<para>While examining a (different) DITA processing performance issue for a client, Saxonica
			carried out some measurements on the size of this pattern-matching problem. The chosen
			situation was one of the stages of expansion of a DITA document into a PDF result, via an
			XSL-FO route. In particular we examined the conversion of a fully formed DITA source into
			XEP-specific XSL-FO source (target <code>transform.topic2fo.main</code> in the DITA-OT build
			script architecture). Through most of the rest of this paper, we'll study in detail the
			processing of a particular source document through this XSLT transformation.</para>
		<sect2>
			<title>Source document and transform</title>
			<para>The processed document had the following characteristics:</para>
			<itemizedlist>
				<listitem>
					<para>An 80 page specification for a electronic component, involving lots of tabular
						descriptions of bit-significances etc.</para>
				</listitem>
				<listitem>
					<para>Source file: 2.66 MB (246kB of redundant whitespace)</para>
				</listitem>
				<listitem>
					<para>Source XML tree: 13,066 elements, 46,831 attributes, 6,093 non-whitespace text nodes
						– total 65,990 significant nodes; tree depth: maximum: 13, average: ~10; sibling width:
						maximum: 57, average: ~2.</para>
				</listitem>
				<listitem>
					<para>Result XML tree: 19,441 elements, 91,048 attributes, 6,140 non-whitespace text
						nodes</para>
				</listitem>
				<listitem>
					<para>Final PDF document: ~80 pages.</para>
				</listitem>
				<listitem>
					<para>The document is very table-heavy – 262 tables with 1,309 rows and 4,863 cells, i.e.
						almost 50% of all the document elements describe table components.</para>
				</listitem>
				<listitem>
					<para>All bar two elements of the source document contain a <code>@class</code> attribute,
						and there are 43 different values for its text value, the most frequent of which is used
						3,683 times. </para>
				</listitem>
			</itemizedlist>
			<para>The processing XSLT transformation had the following characteristics:</para>
			<itemizedlist>
				<listitem>
					<para>58 source files.</para>
				</listitem>
				<listitem>
					<para>70 pattern-matching modes.</para>
				</listitem>
				<listitem>
					<para>418 pattern-matching templates, 155 named templates. (258 of the matching templates
						are in the <code>#default</code> mode.)</para>
				</listitem>
				<listitem>
					<para>5 user-defined functions.</para>
				</listitem>
				<listitem>
					<para>Of the 58 source files, only 33 contain templates. Those that don't either act as
						importation expanders or contain global parameters or attribute sets.</para>
				</listitem>
				<listitem>
					<para>All stylesheet connection is via <code>xsl:import</code>; there is no use of
						inclusion and no multiple importation. The importation tree is relatively shallow, at
						most with a depth of 4 and looks like:</para>
					<figure xml:id="DITA.import">
						<title>DITA-OT stylesheet importation tree for DITA→FO</title>
						<mediaobject>
							<imageobject>
								<imagedata xmlns:xlink="http://www.w3.org/1999/xlink">
									<svg xmlns="http://www.w3.org/2000/svg"
										xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
										xmlns:svg="http://www.w3.org/2000/svg"
										xmlns:doc="http://jwlresearch.net/2012/doc"
										xmlns:fo="http://www.w3.org/1999/XSL/Format"
										xmlns:lay="http://jwlresearch.net/2012/layout"
										xmlns:test="http://jwlresearch.net/2012/TEST" overflow="visible" width="100%"
										height="54.6">
										<svg overflow="visible" stroke="black" stroke-width="1"
											width="548.0000000000002" height="54.6">
											<g stroke="black" stroke-width="1">
												<polyline fill="none"
													points="274.0000000000001 6.1 274.0000000000001 11.100000000000001 259.5000000000001 11.100000000000001 259.5000000000001 16.1"/>
												<polyline fill="none"
													points="274.0000000000001 6.1 274.0000000000001 11.100000000000001 386.75000000000017 11.100000000000001 386.75000000000017 16.1"/>
												<polyline fill="none"
													points="274.0000000000001 6.1 274.0000000000001 11.100000000000001 396.75000000000017 11.100000000000001 396.75000000000017 16.1"/>
												<polyline fill="none"
													points="274.0000000000001 6.1 274.0000000000001 11.100000000000001 524.0000000000002 11.100000000000001 524.0000000000002 16.1"/>
												<polyline fill="none"
													points="274.0000000000001 6.1 274.0000000000001 11.100000000000001 534.5000000000002 11.100000000000001 534.5000000000002 16.1"/>
												<polyline fill="none"
													points="274.0000000000001 6.1 274.0000000000001 11.100000000000001 545.0000000000002 11.100000000000001 545.0000000000002 16.1"
												/>
											</g>
											<circle stroke="red" fill="none" r="3" cx="274.0000000000001" cy="3"/>
											<svg overflow="visible" stroke="black" stroke-width="1"
												width="519.0000000000002" height="38.5" x="0" y="16.1">
												<g stroke="black" stroke-width="1">
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 3 11.100000000000001 3 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 22.00000000000003 11.100000000000001 22.00000000000003 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 41.00000000000003 11.100000000000001 41.00000000000003 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 52.00000000000006 11.100000000000001 52.00000000000006 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 62.50000000000006 11.100000000000001 62.50000000000006 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 72.50000000000006 11.100000000000001 72.50000000000006 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 83.00000000000009 11.100000000000001 83.00000000000009 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 93.50000000000009 11.100000000000001 93.50000000000009 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 104.00000000000009 11.100000000000001 104.00000000000009 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 114.50000000000009 11.100000000000001 114.50000000000009 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 125.00000000000011 11.100000000000001 125.00000000000011 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 135.5000000000001 11.100000000000001 135.5000000000001 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 146.0000000000001 11.100000000000001 146.0000000000001 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 157.0000000000001 11.100000000000001 157.0000000000001 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 167.5000000000001 11.100000000000001 167.5000000000001 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 178.0000000000001 11.100000000000001 178.0000000000001 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 188.5000000000001 11.100000000000001 188.5000000000001 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 199.0000000000001 11.100000000000001 199.0000000000001 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 210.0000000000001 11.100000000000001 210.0000000000001 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 220.5000000000001 11.100000000000001 220.5000000000001 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 231.0000000000001 11.100000000000001 231.0000000000001 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 241.50000000000014 11.100000000000001 241.50000000000014 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 252.00000000000014 11.100000000000001 252.00000000000014 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 263.00000000000017 11.100000000000001 263.00000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 273.50000000000017 11.100000000000001 273.50000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 284.00000000000017 11.100000000000001 284.00000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 294.50000000000017 11.100000000000001 294.50000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 305.00000000000017 11.100000000000001 305.00000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 315.50000000000017 11.100000000000001 315.50000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 326.00000000000017 11.100000000000001 326.00000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 336.50000000000017 11.100000000000001 336.50000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 347.00000000000017 11.100000000000001 347.00000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 357.50000000000017 11.100000000000001 357.50000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 368.00000000000017 11.100000000000001 368.00000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 378.50000000000017 11.100000000000001 378.50000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 389.00000000000017 11.100000000000001 389.00000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 399.50000000000017 11.100000000000001 399.50000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 410.00000000000017 11.100000000000001 410.00000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 421.00000000000017 11.100000000000001 421.00000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 431.50000000000017 11.100000000000001 431.50000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 442.00000000000017 11.100000000000001 442.00000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 452.50000000000017 11.100000000000001 452.50000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 463.00000000000017 11.100000000000001 463.00000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 473.50000000000017 11.100000000000001 473.50000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 484.00000000000017 11.100000000000001 484.00000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 494.50000000000017 11.100000000000001 494.50000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 505.00000000000017 11.100000000000001 505.00000000000017 16.1"/>
													<polyline fill="none"
														points="259.5000000000001 6.1 259.5000000000001 11.100000000000001 516.0000000000002 11.100000000000001 516.0000000000002 16.1"
													/>
												</g>
												<circle stroke="red" fill="none" r="3" cx="259.5000000000001" cy="3"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="0" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="0.7759999999999998">16</text>
												</svg>
												<svg overflow="visible" stroke="black" stroke-width="1" width="28"
													height="22.400000000000002" x="8.000000000000028" y="16.1">
													<g stroke="black" stroke-width="1">
														<polyline fill="none"
															points="14 6.1 14 11.100000000000001 3 11.100000000000001 3 16.1"/>
														<polyline fill="none" points="14 6.1 14 16.1"/>
														<polyline fill="none"
															points="14 6.1 14 11.100000000000001 25 11.100000000000001 25 16.1"/>
													</g>
													<circle stroke="red" fill="none" r="3" cx="14" cy="3"/>
													<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
														font-size="4" text-align="center" background-color="green" width="6"
														height="6.3" x="0" y="16.1">
														<rect fill="green" x="0" y="0" width="6" height="6.3"/>
														<text y="3.872" x="0.7759999999999998">16</text>
													</svg>
													<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
														font-size="4" text-align="center" background-color="green" width="6"
														height="6.3" x="11" y="16.1">
														<rect fill="green" x="0" y="0" width="6" height="6.3"/>
														<text y="3.872" x="1.888">1</text>
													</svg>
													<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
														font-size="4" text-align="center" background-color="green" width="6"
														height="6.3" x="22" y="16.1">
														<rect fill="green" x="0" y="0" width="6" height="6.3"/>
														<text y="3.872" x="1.888">1</text>
													</svg>
												</svg>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="38.00000000000003" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="1.888">4</text>
												</svg>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="49.00000000000006" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="1.888">4</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="60.00000000000006"
													y="16.1"/>
												<rect stroke="green" fill="none" width="5" height="5" x="70.00000000000006"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="80.00000000000009" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="1.888">3</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="91.00000000000009"
													y="16.1"/>
												<svg overflow="visible" stroke="black" stroke-width="1" width="6"
													height="22.400000000000002" x="101.00000000000009" y="16.1">
													<g stroke="black" stroke-width="1">
														<polyline fill="none" points="3 6.1 3 16.1"/>
													</g>
													<circle stroke="red" fill="red" r="3" cx="3" cy="3"/>
													<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
														font-size="4" text-align="center" background-color="green" width="6"
														height="6.3" x="0" y="16.1">
														<rect fill="green" x="0" y="0" width="6" height="6.3"/>
														<text y="3.872" x="1.888">4</text>
													</svg>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="112.00000000000009"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="122.00000000000011" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="1.888">8</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="133.0000000000001"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" mark="blue"
													width="6" height="6.3" x="143.0000000000001" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="0.7759999999999998">61</text>
												</svg>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="154.0000000000001" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="0.7759999999999998">10</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="165.0000000000001"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="175.0000000000001" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="-0.33599999999999985">140</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="186.0000000000001"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="196.0000000000001" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="0.7759999999999998">23</text>
												</svg>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="207.0000000000001" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="1.888">9</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="218.0000000000001"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="228.0000000000001" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="0.7759999999999998">32</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="239.00000000000014"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="249.00000000000014" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="0.7759999999999998">20</text>
												</svg>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="260.00000000000017" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="1.888">1</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="271.00000000000017"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="281.00000000000017" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.824" x="1.888">7</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="292.00000000000017"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="302.00000000000017" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="0.7759999999999998">30</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="313.00000000000017"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="323.00000000000017" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="0.7759999999999998">11</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="334.00000000000017"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="344.00000000000017" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="1.888">8</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="355.00000000000017"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" mark="orange"
													width="6" height="6.3" x="365.00000000000017" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="0.7759999999999998">35</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="376.00000000000017"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="386.00000000000017" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="1.888">6</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="397.00000000000017"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="407.00000000000017" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="1.888">6</text>
												</svg>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="418.00000000000017" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="1.888">8</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="429.00000000000017"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="439.00000000000017" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="0.7759999999999998">43</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="450.00000000000017"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="460.00000000000017" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="1.888">2</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="471.00000000000017"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="481.00000000000017" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="1.888">6</text>
												</svg>
												<rect stroke="green" fill="none" width="5" height="5" x="492.00000000000017"
													y="16.1"/>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="502.00000000000017" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="1.888">1</text>
												</svg>
												<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
													font-size="4" text-align="center" background-color="green" width="6"
													height="6.3" x="513.0000000000002" y="16.1">
													<rect fill="green" x="0" y="0" width="6" height="6.3"/>
													<text y="3.872" x="0.7759999999999998">10</text>
												</svg>
											</svg>
											<rect stroke="green" fill="none" width="5" height="5" x="384.25000000000017"
												y="16.1"/>
											<rect stroke="green" fill="none" width="5" height="5" x="394.25000000000017"
												y="16.1"/>
											<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
												font-size="4" text-align="center" background-color="green" width="6"
												height="6.3" x="521.0000000000002" y="16.1">
												<rect fill="green" x="0" y="0" width="6" height="6.3"/>
												<text y="3.872" x="1.888">1</text>
											</svg>
											<rect stroke="green" fill="none" width="5" height="5" x="532.0000000000002"
												y="16.1"/>
											<svg stroke="none" fill="white" font-family="Helvetica" font-weight="bold"
												font-size="4" text-align="center" background-color="green" width="6"
												height="6.3" x="542.0000000000002" y="16.1">
												<rect fill="green" x="0" y="0" width="6" height="6.3"/>
												<text y="3.872" x="1.888">3</text>
											</svg>
										</svg>
										<circle r="7" stroke="blue" fill="none" stroke-width="2" cx="146.0000000000001"
											cy="35.35"/>
										<circle r="7" stroke="orange" fill="none" stroke-width="2"
											cx="368.00000000000017" cy="35.35"/>
									</svg>
								</imagedata>
							</imageobject>
						</mediaobject>
					</figure>
					<para>where solid nodes indicate stylesheets that contain templates and circles denote
						stylesheets that import other stylesheets. (The two leaf nodes circled are stylesheets
						containing the most frequently used templates. The consequences of this are discussed in
							<xref linkend="rule.ambiguity"/>.)</para>
				</listitem>
			</itemizedlist>
		</sect2>
		<sect2>
			<title>Processing characteristics</title>
			<para>Using Saxon 9.6EE on a quad-core i7 1.6 GHz laptop running 64-bit Windows7 with 4GB of
				RAM, the processing took around 15 seconds. But of more interest are some of the internal
				statistics. In processing this document to completion, 75,950 template rules 'executed',
				i.e. their patterns matched and their sequence constructor bodies were processed further<footnote>
					<para>A union pattern (<code>pattern1 | pattern2</code>) is considered to be a set of
						separate matches for this analysis - one for each pattern.</para>
				</footnote>. (This is comensurate with a model where most nodes are only 'touched' once
				during processing.) Determining which rule to execute at each stage took approximately 4.5
				seconds, i.e. <emphasis>~ 30% of all processing involved template pattern
					matching.</emphasis>
			</para>
			<para>Of the 70 pattern matching modes in the source XSLT, only 35 were active on this
				document and only three have significant performance impact, accounting for 96% of all the
				calls and 99.7% of all the time taken matching template patterns.</para>
			<table frame="all">
				<title>Significant Modes</title>
				<tgroup cols="6">
					<colspec colname="c1" colnum="1" colwidth="1.0*"/>
					<colspec colname="newCol2" colnum="2" colwidth="1*"/>
					<colspec colname="c2" colnum="3" colwidth="1.0*"/>
					<colspec colname="c3" colnum="4" colwidth="1.0*"/>
					<colspec colname="c4" colnum="5" colwidth="1.0*"/>
					<colspec colname="c5" colnum="6" colwidth="1.0*"/>
					<thead>
						<row>
							<entry align="center">Mode</entry>
							<entry align="center">Purpose</entry>
							<entry align="center"># invocations</entry>
							<entry align="center">% invocations</entry>
							<entry align="center">time / ms</entry>
							<entry align="center">%time</entry>
						</row>
					</thead>
					<tbody>
						<row>
							<entry>
								<code>#default</code>
							</entry>
							<entry>General</entry>
							<entry align="right">13,095</entry>
							<entry align="right">17.2</entry>
							<entry align="right">4,330</entry>
							<entry align="right">97.8</entry>
						</row>
						<row>
							<entry>
								<code>toc</code>
							</entry>
							<entry>Table of Contents</entry>
							<entry align="right">22,088</entry>
							<entry align="right">29.1</entry>
							<entry align="right">51</entry>
							<entry align="right">1.1</entry>
						</row>
						<row>
							<entry>
								<code>bookmark</code>
							</entry>
							<entry>Bookmarks</entry>
							<entry align="right">37,752</entry>
							<entry align="right">49.7</entry>
							<entry align="right">33</entry>
							<entry align="right">0.8</entry>
						</row>
					</tbody>
				</tgroup>
			</table>
			<para>Whilst the proportion of the number of invocations depends upon characteristics of the
				document and the DITA-OT framework, the performance costs per node depend upon the
				complexity of the patterns involved. Thus if we examine the patterns for the
					<code>#default</code> mode, it immediately becomes apparent why there is such
				disparity.</para>
			<table frame="all">
				<title>Mode Patterns</title>
				<tgroup cols="6">
					<colspec colname="c1" colnum="1" colwidth="1.23*"/>
					<colspec colname="newCol2" colnum="2" colwidth="1.23*"/>
					<colspec colname="c2" colnum="3" colwidth="1*"/>
					<colspec colname="newCol4" colnum="4" colwidth="1.4*"/>
					<colspec colname="newCol6" colnum="5" colwidth="1.39*"/>
					<colspec colname="newCol5" colnum="6" colwidth="1.07*"/>
					<thead>
						<row>
							<entry morerows="1" align="center">Mode</entry>
							<entry morerows="1" align="center">Purpose</entry>
							<entry namest="c2" nameend="newCol6" align="center"># template patterns in
								mode</entry>
							<entry morerows="1" align="center">#templates matched</entry>
						</row>
						<row>
							<entry align="center">element(*)</entry>
							<entry align="center">element(<emphasis role="italic">named</emphasis>)</entry>
							<entry align="center">attribute(<emphasis role="italic">named</emphasis>)</entry>
						</row>
					</thead>
					<tbody>
						<row>
							<entry>
								<code>#default</code>
							</entry>
							<entry>General</entry>
							<entry align="right">240</entry>
							<entry align="right">19</entry>
							<entry align="right">8</entry>
							<entry align="right">39</entry>
						</row>
						<row>
							<entry>
								<code>toc</code>
							</entry>
							<entry>Table of Contents</entry>
							<entry align="right">2</entry>
							<entry align="right">4</entry>
							<entry align="right">0</entry>
							<entry align="right">3</entry>
						</row>
						<row>
							<entry>
								<code>bookmark</code>
							</entry>
							<entry>Bookmarks</entry>
							<entry align="right">2</entry>
							<entry align="right">5</entry>
							<entry align="right">0</entry>
							<entry align="right">3</entry>
						</row>
					</tbody>
				</tgroup>
			</table>
			<para>Clearly the number of the template rules that need to be checked for unnamed elements
					(<code>*</code>) in the <code>#default</code> mode dominates. How do these 240 templates
				differ? Firstly as the DITA -OT framework uses a large number of files via
					<code>xsl:import</code> inclusions, they have strongly differing precedences <footnote>
					<para>There is no use of the <code>xsl:apply-imports</code> instruction within the
						framework, implying a simple overriding model. <code>xsl:next-match</code> is not used
						either, though that wasn't present in XSLT1.0</para>
				</footnote>. Template match patterns also have differing implicit or explicit priorities.
				Together these two properties constitute a <emphasis>rank</emphasis>, precedence before
				priority - matching higher rank patterns are chosen over lower. When multiple patterns match
				at the same rank optionally either the last in sequence is chosen or a dynamic error is
				thrown.</para>
			<para>In this case, the 240 templates are spread across 25 different ranks, with the sequence
				order distribution shown in <xref linkend="rank.distribution"/>.</para>
			<figure xml:id="rank.distribution">
				<title>Template rule order and precedence ranking</title>
				<mediaobject>
					<imageobject>
						<imagedata xmlns:xlink="http://www.w3.org/1999/xlink">
							<svg xmlns="http://www.w3.org/2000/svg" xmlns:db="http://docbook.org/ns/docbook"
								width="100%" height="100%" viewBox="0 0 1100 575">
								<desc/>
								<text x="20" y="20" font-size="10">2015-05-03T13:10:30.615+01:00</text>
								<g alignment-baseline="baseline" transform="translate(40,40)">
									<g>
										<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="500" y2="500"/>
										<text class="axis" font-size="10" text-anchor="end" x="0" y="500">0</text>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="485.29411764705884"
											y2="485.29411764705884"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="470.5882352941176"
											y2="470.5882352941176"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="455.88235294117646"
											y2="455.88235294117646"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="441.1764705882353"
											y2="441.1764705882353"/>
										<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="426.47058823529414"
											y2="426.47058823529414"/>
										<text class="axis" font-size="10" text-anchor="end" x="0" y="426.47058823529414"
											>5</text>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="411.7647058823529"
											y2="411.7647058823529"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="397.05882352941177"
											y2="397.05882352941177"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="382.3529411764706"
											y2="382.3529411764706"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="367.6470588235294"
											y2="367.6470588235294"/>
										<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="352.94117647058823"
											y2="352.94117647058823"/>
										<text class="axis" font-size="10" text-anchor="end" x="0" y="352.94117647058823"
											>10</text>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="338.2352941176471"
											y2="338.2352941176471"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="323.52941176470586"
											y2="323.52941176470586"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="308.82352941176475"
											y2="308.82352941176475"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="294.11764705882354"
											y2="294.11764705882354"/>
										<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="279.4117647058824"
											y2="279.4117647058824"/>
										<text class="axis" font-size="10" text-anchor="end" x="0" y="279.4117647058824"
											>15</text>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="264.7058823529412"
											y2="264.7058823529412"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="250" y2="250"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="235.29411764705884"
											y2="235.29411764705884"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="220.58823529411768"
											y2="220.58823529411768"/>
										<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="205.88235294117646"
											y2="205.88235294117646"/>
										<text class="axis" font-size="10" text-anchor="end" x="0" y="205.88235294117646"
											>20</text>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="191.1764705882353"
											y2="191.1764705882353"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="176.47058823529414"
											y2="176.47058823529414"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="161.76470588235298"
											y2="161.76470588235298"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="147.05882352941177"
											y2="147.05882352941177"/>
										<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="132.3529411764706"
											y2="132.3529411764706"/>
										<text class="axis" font-size="10" text-anchor="end" x="0" y="132.3529411764706"
											>25</text>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="117.64705882352945"
											y2="117.64705882352945"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="102.94117647058823"
											y2="102.94117647058823"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="88.23529411764707"
											y2="88.23529411764707"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="73.52941176470591"
											y2="73.52941176470591"/>
										<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="58.82352941176475"
											y2="58.82352941176475"/>
										<text class="axis" font-size="10" text-anchor="end" x="0" y="58.82352941176475"
											>30</text>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="44.117647058823536"
											y2="44.117647058823536"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="29.411764705882376"
											y2="29.411764705882376"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="14.705882352941217"
											y2="14.705882352941217"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="0" y2="0"/>
										<text transform="rotate(-90,-10,250)" y="250" x="-10" class="axis label"
											text-anchor="middle" font-family="arial" font-weight="bold" font-size="12pt"
											style="font-family:arial;font-weight:bold;font-size:12pt">Rank</text>
									</g>
									<g>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="0" x2="0"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="0"
											>0</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="40" x2="40"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="80" x2="80"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="120" x2="120"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="160" x2="160"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="200" x2="200"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="200"
											>50</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="240" x2="240"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="280" x2="280"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="320" x2="320"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="360" x2="360"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="400" x2="400"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="400"
											>100</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="440" x2="440"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="480" x2="480"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="520" x2="520"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="560" x2="560"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="600" x2="600"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="600"
											>150</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="640" x2="640"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="680" x2="680"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="720" x2="720"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="760" x2="760"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="800" x2="800"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="800"
											>200</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="840" x2="840"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="880" x2="880"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="920" x2="920"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="960" x2="960"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="1000" x2="1000"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="1000"
											>250</text>
										<text x="500" y="530" class="axis label" text-anchor="middle"
											font-family="arial" font-weight="bold" font-size="12pt"
											style="font-family:arial;font-weight:bold;font-size:12pt">Rule order</text>
									</g>
									<g transform="translate(500,250)">
										<text class="label" x="0" y="20" font-family="arial" font-weight="bold"
											font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
											>Template rank distribution</text>
										<text class="label" x="0" y="40" font-family="arial" font-weight="bold"
											font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
											>mode:#default</text>
									</g>
									<g>
										<line class="rank" x1="2" x2="6" y1="14.705882352941217" y2="14.705882352941217"
											stroke="red" stroke-width="3pt" style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="6" x2="10" y1="44.117647058823536"
											y2="44.117647058823536" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="10" x2="14" y1="73.52941176470591" y2="73.52941176470591"
											stroke="red" stroke-width="3pt" style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="14" x2="34" y1="88.23529411764707" y2="88.23529411764707"
											stroke="red" stroke-width="3pt" style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="34" x2="58" y1="102.94117647058823"
											y2="102.94117647058823" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="58" x2="210" y1="117.64705882352945"
											y2="117.64705882352945" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="210" x2="242" y1="132.3529411764706"
											y2="132.3529411764706" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="242" x2="246" y1="147.05882352941177"
											y2="147.05882352941177" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="246" x2="270" y1="161.76470588235298"
											y2="161.76470588235298" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="270" x2="274" y1="176.47058823529414"
											y2="176.47058823529414" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="274" x2="378" y1="191.1764705882353"
											y2="191.1764705882353" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="378" x2="406" y1="205.88235294117646"
											y2="205.88235294117646" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="406" x2="414" y1="220.58823529411768"
											y2="220.58823529411768" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="414" x2="418" y1="235.29411764705884"
											y2="235.29411764705884" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="418" x2="462" y1="250" y2="250" stroke="red"
											stroke-width="3pt" style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="462" x2="466" y1="279.4117647058824"
											y2="279.4117647058824" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="466" x2="470" y1="308.82352941176475"
											y2="308.82352941176475" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="470" x2="474" y1="338.2352941176471"
											y2="338.2352941176471" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="474" x2="482" y1="352.94117647058823"
											y2="352.94117647058823" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="482" x2="794" y1="367.6470588235294"
											y2="367.6470588235294" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="794" x2="902" y1="426.47058823529414"
											y2="426.47058823529414" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="902" x2="934" y1="441.1764705882353"
											y2="441.1764705882353" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="934" x2="938" y1="455.88235294117646"
											y2="455.88235294117646" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="938" x2="942" y1="470.5882352941176"
											y2="470.5882352941176" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
										<line class="rank" x1="942" x2="970" y1="485.29411764705884"
											y2="485.29411764705884" stroke="red" stroke-width="3pt"
											style="stroke:red;stroke-width:3pt"/>
									</g>
								</g>
							</svg>
						</imagedata>
					</imageobject>
				</mediaobject>
			</figure>
			<para>Missing ranks involve templates matching named elements and attributes. The overall
				total of 35 ranks is in line with the approximately 33 imported stylesheets of the
				framework. Within a rank rules are ordered in reverse document order as when ambiguous rules
				are permitted <emphasis>later</emphasis> rules are chosen; hence they are placed earlier
				within order within a rank. Details for the most heavily used ranks are given in the
				following table:</para>
			<table xml:id="table.ranks" frame="all"
				xml:base="../../../tests/john/dita/ATests/svg/normal/modes/saxon-defaultMode/table.ranks.db">
				<title>Heavily populated pattern ranks in mode #default</title>
				<tgroup cols="12">
					<tbody>
						<row>
							<entry>Rank</entry>
							<entry align="right">27</entry>
							<entry align="right">26</entry>
							<entry align="right">25</entry>
							<entry align="right">23</entry>
							<entry align="right">21</entry>
							<entry align="right">20</entry>
							<entry align="right">17</entry>
							<entry align="right">9</entry>
							<entry align="right">5</entry>
							<entry align="right">4</entry>
							<entry align="right">1</entry>
						</row>
						<row>
							<entry>start</entry>
							<entry align="right">9</entry>
							<entry align="right">15</entry>
							<entry align="right">53</entry>
							<entry align="right">62</entry>
							<entry align="right">69</entry>
							<entry align="right">95</entry>
							<entry align="right">105</entry>
							<entry align="right">121</entry>
							<entry align="right">199</entry>
							<entry align="right">226</entry>
							<entry align="right">236</entry>
						</row>
						<row>
							<entry>end</entry>
							<entry align="right">14</entry>
							<entry align="right">52</entry>
							<entry align="right">60</entry>
							<entry align="right">67</entry>
							<entry align="right">94</entry>
							<entry align="right">101</entry>
							<entry align="right">115</entry>
							<entry align="right">198</entry>
							<entry align="right">225</entry>
							<entry align="right">233</entry>
							<entry align="right">242</entry>
						</row>
						<row>
							<entry>size</entry>
							<entry align="right">6</entry>
							<entry align="right">38</entry>
							<entry align="right">8</entry>
							<entry align="right">6</entry>
							<entry align="right">26</entry>
							<entry align="right">7</entry>
							<entry align="right">11</entry>
							<entry align="right">78</entry>
							<entry align="right">27</entry>
							<entry align="right">8</entry>
							<entry align="right">7</entry>
						</row>
					</tbody>
				</tgroup>
			</table>
			<para>Rank 5 contains mostly templates associated with tables, from the stylesheet
					<code>tables.xsl</code> and these table-matching templates appear to be unique, i.e. no
				templates in other stylesheets would be anticipated to match. Rank 26 (from
					<code>pr-domain.xsl</code>) contains templates for the programming domain.</para>
			<para>As already remarked, all templates of a given rank are candidates to match in preference
				to those of a lower rank. Thus for example, when processing a node whose correctly matching
				template is that with order number 150 and rank 9, all the 122 templates of higher rank must
				be eliminated, <emphasis>and all the 78 templates of equal rank tested for possible
					conflict</emphasis>, i.e. a total of just under 200 template match conditions must be
				examined.</para>
			<para>We've examined the rank ordering of all the templates used in the <code>#default</code>
				mode, but which are actually matched within the processing of this sample document? <xref
					linkend="rank.use"/> shows the distribution of the 39 templates that were invoked. </para>
			<figure xml:id="rank.use">
				<title>Rule order and precedence of matched templates</title>
				<mediaobject>
					<imageobject>
						<imagedata xmlns:xlink="http://www.w3.org/1999/xlink">
							<svg xmlns="http://www.w3.org/2000/svg" xmlns:db="http://docbook.org/ns/docbook"
								width="100%" height="100%" viewBox="0 0 1100 575">
								<desc/>
								<text x="20" y="20" font-size="10">2015-05-03T13:10:30.615+01:00</text>
								<g alignment-baseline="baseline" transform="translate(40,40)">
									<g>
										<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="500" y2="500"/>
										<text class="axis" font-size="10" text-anchor="end" x="0" y="500">0</text>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="485.29411764705884"
											y2="485.29411764705884"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="470.5882352941176"
											y2="470.5882352941176"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="455.88235294117646"
											y2="455.88235294117646"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="441.1764705882353"
											y2="441.1764705882353"/>
										<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="426.47058823529414"
											y2="426.47058823529414"/>
										<text class="axis" font-size="10" text-anchor="end" x="0" y="426.47058823529414"
											>5</text>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="411.7647058823529"
											y2="411.7647058823529"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="397.05882352941177"
											y2="397.05882352941177"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="382.3529411764706"
											y2="382.3529411764706"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="367.6470588235294"
											y2="367.6470588235294"/>
										<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="352.94117647058823"
											y2="352.94117647058823"/>
										<text class="axis" font-size="10" text-anchor="end" x="0" y="352.94117647058823"
											>10</text>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="338.2352941176471"
											y2="338.2352941176471"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="323.52941176470586"
											y2="323.52941176470586"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="308.82352941176475"
											y2="308.82352941176475"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="294.11764705882354"
											y2="294.11764705882354"/>
										<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="279.4117647058824"
											y2="279.4117647058824"/>
										<text class="axis" font-size="10" text-anchor="end" x="0" y="279.4117647058824"
											>15</text>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="264.7058823529412"
											y2="264.7058823529412"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="250" y2="250"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="235.29411764705884"
											y2="235.29411764705884"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="220.58823529411768"
											y2="220.58823529411768"/>
										<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="205.88235294117646"
											y2="205.88235294117646"/>
										<text class="axis" font-size="10" text-anchor="end" x="0" y="205.88235294117646"
											>20</text>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="191.1764705882353"
											y2="191.1764705882353"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="176.47058823529414"
											y2="176.47058823529414"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="161.76470588235298"
											y2="161.76470588235298"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="147.05882352941177"
											y2="147.05882352941177"/>
										<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="132.3529411764706"
											y2="132.3529411764706"/>
										<text class="axis" font-size="10" text-anchor="end" x="0" y="132.3529411764706"
											>25</text>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="117.64705882352945"
											y2="117.64705882352945"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="102.94117647058823"
											y2="102.94117647058823"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="88.23529411764707"
											y2="88.23529411764707"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="73.52941176470591"
											y2="73.52941176470591"/>
										<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="58.82352941176475"
											y2="58.82352941176475"/>
										<text class="axis" font-size="10" text-anchor="end" x="0" y="58.82352941176475"
											>30</text>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="44.117647058823536"
											y2="44.117647058823536"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="29.411764705882376"
											y2="29.411764705882376"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="14.705882352941217"
											y2="14.705882352941217"/>
										<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="0" y2="0"/>
										<text transform="rotate(-90,-10,250)" y="250" x="-10" class="axis label"
											text-anchor="middle" font-family="arial" font-weight="bold" font-size="12pt"
											style="font-family:arial;font-weight:bold;font-size:12pt">Rank</text>
									</g>
									<g>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="0" x2="0"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="0"
											>0</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="40" x2="40"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="80" x2="80"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="120" x2="120"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="160" x2="160"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="200" x2="200"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="200"
											>50</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="240" x2="240"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="280" x2="280"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="320" x2="320"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="360" x2="360"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="400" x2="400"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="400"
											>100</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="440" x2="440"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="480" x2="480"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="520" x2="520"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="560" x2="560"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="600" x2="600"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="600"
											>150</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="640" x2="640"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="680" x2="680"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="720" x2="720"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="760" x2="760"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="800" x2="800"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="800"
											>200</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="840" x2="840"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="880" x2="880"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="920" x2="920"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="960" x2="960"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="1000" x2="1000"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="1000"
											>250</text>
										<text x="500" y="530" class="axis label" text-anchor="middle"
											font-family="arial" font-weight="bold" font-size="12pt"
											style="font-family:arial;font-weight:bold;font-size:12pt">Rule order</text>
									</g>
									<g transform="translate(500,250)">
										<text class="label" x="0" y="20" font-family="arial" font-weight="bold"
											font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
											>Templates used with mode: #default</text>
									</g>
									<g>
										<line class="rankFeint" x1="2" x2="6" y1="14.705882352941217"
											y2="14.705882352941217" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="6" x2="10" y1="44.117647058823536"
											y2="44.117647058823536" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="10" x2="14" y1="73.52941176470591"
											y2="73.52941176470591" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="14" x2="34" y1="88.23529411764707"
											y2="88.23529411764707" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="34" x2="58" y1="102.94117647058823"
											y2="102.94117647058823" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="58" x2="210" y1="117.64705882352945"
											y2="117.64705882352945" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="210" x2="242" y1="132.3529411764706"
											y2="132.3529411764706" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="242" x2="246" y1="147.05882352941177"
											y2="147.05882352941177" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="246" x2="270" y1="161.76470588235298"
											y2="161.76470588235298" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="270" x2="274" y1="176.47058823529414"
											y2="176.47058823529414" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="274" x2="378" y1="191.1764705882353"
											y2="191.1764705882353" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="378" x2="406" y1="205.88235294117646"
											y2="205.88235294117646" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="406" x2="414" y1="220.58823529411768"
											y2="220.58823529411768" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="414" x2="418" y1="235.29411764705884"
											y2="235.29411764705884" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="418" x2="462" y1="250" y2="250" stroke="red"
											stroke-width="1pt" style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="462" x2="466" y1="279.4117647058824"
											y2="279.4117647058824" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="466" x2="470" y1="308.82352941176475"
											y2="308.82352941176475" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="470" x2="474" y1="338.2352941176471"
											y2="338.2352941176471" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="474" x2="482" y1="352.94117647058823"
											y2="352.94117647058823" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="482" x2="794" y1="367.6470588235294"
											y2="367.6470588235294" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="794" x2="902" y1="426.47058823529414"
											y2="426.47058823529414" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="902" x2="934" y1="441.1764705882353"
											y2="441.1764705882353" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="934" x2="938" y1="455.88235294117646"
											y2="455.88235294117646" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="938" x2="942" y1="470.5882352941176"
											y2="470.5882352941176" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<line class="rankFeint" x1="942" x2="970" y1="485.29411764705884"
											y2="485.29411764705884" stroke="red" stroke-width="1pt"
											style="stroke:red;stroke-width:1pt"/>
										<circle fill="blue" stroke="none" cx="480" cy="352.94117647058823" r="4"/>
										<circle fill="blue" stroke="none" cx="968" cy="485.29411764705884" r="4"/>
										<circle fill="blue" stroke="none" cx="920" cy="441.1764705882353" r="4"/>
										<circle fill="blue" stroke="none" cx="788" cy="367.6470588235294" r="4"/>
										<circle fill="blue" stroke="none" cx="792" cy="367.6470588235294" r="4"/>
										<circle fill="blue" stroke="none" cx="616" cy="367.6470588235294" r="4"/>
										<circle fill="blue" stroke="none" cx="836" cy="426.47058823529414" r="4"/>
										<circle fill="blue" stroke="none" cx="832" cy="426.47058823529414" r="4"/>
										<circle fill="blue" stroke="none" cx="812" cy="426.47058823529414" r="4"/>
										<circle fill="blue" stroke="none" cx="844" cy="426.47058823529414" r="4"/>
										<circle fill="blue" stroke="none" cx="828" cy="426.47058823529414" r="4"/>
										<circle fill="blue" stroke="none" cx="852" cy="426.47058823529414" r="4"/>
										<circle fill="blue" stroke="none" cx="804" cy="426.47058823529414" r="4"/>
										<circle fill="blue" stroke="none" cx="820" cy="426.47058823529414" r="4"/>
										<circle fill="blue" stroke="none" cx="840" cy="426.47058823529414" r="4"/>
										<circle fill="blue" stroke="none" cx="824" cy="426.47058823529414" r="4"/>
										<circle fill="blue" stroke="none" cx="796" cy="426.47058823529414" r="4"/>
										<circle fill="blue" stroke="none" cx="604" cy="367.6470588235294" r="4"/>
										<circle fill="blue" stroke="none" cx="208" cy="117.64705882352945" r="4"/>
										<circle fill="blue" stroke="none" cx="816" cy="426.47058823529414" r="4"/>
										<circle fill="none" stroke="green" cx="208" cy="117.64705882352945" r="10"
											stroke-width="3"/>
										<circle fill="none" stroke="green" cx="816" cy="426.47058823529414" r="10"
											stroke-width="3"/>
										<circle fill="none" stroke="green" cx="604" cy="367.6470588235294" r="10"
											stroke-width="3"/>
										<circle fill="none" stroke="green" cx="796" cy="426.47058823529414" r="10"
											stroke-width="3"/>
									</g>
								</g>
							</svg>
						</imagedata>
					</imageobject>
				</mediaobject>
			</figure>
			<para>The blue dots indicate order/rank of matched templates, the green circles surround the
				four most frequently matched of these, the implications of which are discussed below. What
				are the most frequently matched templates? <xref linkend="frequent.matches"/> shows the
				percentage of all matches taken by the ten most significant, labelled with rule order, rank
				and (abbreviated) match pattern.</para>
			<figure xml:id="frequent.matches">
				<title>Most frequently matched templates</title>
				<mediaobject>
					<imageobject>
						<imagedata xmlns:xlink="http://www.w3.org/1999/xlink">
							<svg xmlns="http://www.w3.org/2000/svg" xmlns:db="http://docbook.org/ns/docbook"
								width="100%" height="100%" viewBox="0 0 1100 575">
								<desc/>
								<text x="20" y="20" font-size="10">2015-05-03T13:10:30.615+01:00</text>
								<g alignment-baseline="baseline" transform="translate(40,40)">
									<g>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="0" x2="0"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="0"
											>0</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="34.48275862068966"
											x2="34.48275862068966"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="68.96551724137932"
											x2="68.96551724137932"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="103.44827586206898"
											x2="103.44827586206898"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="137.93103448275863"
											x2="137.93103448275863"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="172.41379310344828"
											x2="172.41379310344828"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510"
											x="172.41379310344828">5</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="206.89655172413796"
											x2="206.89655172413796"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="241.37931034482762"
											x2="241.37931034482762"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="275.86206896551727"
											x2="275.86206896551727"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="310.3448275862069"
											x2="310.3448275862069"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="344.82758620689657"
											x2="344.82758620689657"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510"
											x="344.82758620689657">10</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="379.3103448275862"
											x2="379.3103448275862"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="413.79310344827593"
											x2="413.79310344827593"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="448.2758620689656"
											x2="448.2758620689656"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="482.75862068965523"
											x2="482.75862068965523"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="517.2413793103449"
											x2="517.2413793103449"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510"
											x="517.2413793103449">15</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="551.7241379310345"
											x2="551.7241379310345"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="586.2068965517242"
											x2="586.2068965517242"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="620.6896551724138"
											x2="620.6896551724138"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="655.1724137931035"
											x2="655.1724137931035"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="689.6551724137931"
											x2="689.6551724137931"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510"
											x="689.6551724137931">20</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="724.1379310344828"
											x2="724.1379310344828"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="758.6206896551724"
											x2="758.6206896551724"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="793.1034482758621"
											x2="793.1034482758621"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="827.5862068965519"
											x2="827.5862068965519"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="862.0689655172415"
											x2="862.0689655172415"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510"
											x="862.0689655172415">25</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="896.5517241379312"
											x2="896.5517241379312"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="931.0344827586208"
											x2="931.0344827586208"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="965.5172413793105"
											x2="965.5172413793105"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="1000.0000000000001"
											x2="1000.0000000000001"/>
										<text x="500" y="530" class="axis label" text-anchor="middle"
											font-family="arial" font-weight="bold" font-size="12pt"
											style="font-family:arial;font-weight:bold;font-size:12pt">% of calls</text>
									</g>
									<g transform="translate(500,100)">
										<text class="label" x="0" y="20" font-family="arial" font-weight="bold"
											font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
											>Most frequent templates</text>
										<text class="label" x="0" y="40" font-family="arial" font-weight="bold"
											font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
											>mode:#default</text>
									</g>
									<g>
										<g>
											<text class="match" x="17.24137931034483" y="6.097560975609724"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">52:26: @C{
												pr-d/codeph }</text>
											<line class="OFF total" x1="0" x2="983.8859621939883" y1="12.195121951219505"
												y2="12.195121951219505" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="17.24137931034483" y="54.8780487804878"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">204:5: @C{
												topic/tbody }/@C{ topic/row }/@C{ topic/entry }</text>
											<line class="OFF total" x1="0" x2="862.8703931269569" y1="60.97560975609758"
												y2="60.97560975609758" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="17.24137931034483" y="103.65853658536582"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">151:9: @C{ topic/p
												}</text>
											<line class="OFF total" x1="0" x2="294.1239327655664" y1="109.7560975609756"
												y2="109.7560975609756" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="17.24137931034483" y="152.4390243902439"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">199:5: @C{
												topic/strow }/@C{ topic/stentry }</text>
											<line class="OFF total" x1="0" x2="258.8611179380871" y1="158.53658536585363"
												y2="158.53658536585363" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="17.24137931034483" y="201.21951219512192"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">206:5: @C{
												topic/tbody }/@C{ topic/row }</text>
											<line class="OFF total" x1="0" x2="183.2597800882639" y1="207.3170731707317"
												y2="207.3170731707317" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="17.24137931034483" y="250" font-family="arial"
												font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">205:5: @C{
												topic/thead }/@C{ topic/row }/@C{ topic/entry }</text>
											<line class="OFF total" x1="0" x2="176.58121667396858" y1="256.0975609756098"
												y2="256.0975609756098" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="17.24137931034483" y="298.780487804878"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">210:5: @C{
												topic/colspec }</text>
											<line class="OFF total" x1="0" x2="175.51264652768134" y1="304.8780487804878"
												y2="304.8780487804878" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="17.24137931034483" y="347.5609756097561"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">201:5: @C{
												topic/strow }</text>
											<line class="OFF total" x1="0" x2="129.29698770075763" y1="353.6585365853658"
												y2="353.6585365853658" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="17.24137931034483" y="396.3414634146342"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">207:5: @C{
												topic/thead }/@C{ topic/row }</text>
											<line class="OFF total" x1="0" x2="37.13281258348205" y1="402.4390243902439"
												y2="402.4390243902439" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="17.24137931034483" y="445.1219512195122"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">209:5: @C{
												topic/thead }</text>
											<line class="OFF total" x1="0" x2="36.59852751033842" y1="451.219512195122"
												y2="451.219512195122" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
									</g>
								</g>
							</svg>
						</imagedata>
						<!--<imagedata width="10cm" depth="7cm"
                            fileref="../../../tests/john/dita/ATests/svg/normal/modes/saxon-defaultMode/calls.svg"
                            format="SVG"/>-->
					</imageobject>
				</mediaobject>
			</figure>
			<para>For this document the most commonly matched template in the <code>#default</code> mode,
				accounting for 28% of unnamed element matches, has order number 52 (it matches
					<code>pr-d-codeph</code>) but the next most called (25%, matching topic table entries) has
				order number 204 and rank 5. (Their positions are circled in green in <xref
					linkend="rank.use"/>.) The next 6 most commonly matched templates account for 35% of calls
				collectively and are in ranks 9 and 5.</para>
			<para>So we have the situation that whilst for 28% of the successful element matches 50
				patterns must be checked each time (i.e. the end of rank 26), for more than 60% of the
				matches, either 200 or 225 patterns must be checked.</para>
			<para>Thus far we haven't looked at what these patterns are, merely their required order of
				checking. Let's examine the top seven unnamed element patterns in the <code>#default</code>
				mode:</para>
			<table frame="all" xml:id="table.frequent.patterns"
				xml:base="../../../tests/john/dita/ATests/svg/normal/modes/saxon-defaultMode/table.db">
				<title>Most frequent patterns in mode #default</title>
				<tgroup cols="4">
					<colspec colname="c1" colnum="1" colwidth="1.03*"/>
					<colspec colname="c2" colnum="2" colwidth="1*"/>
					<colspec colname="c3" colnum="3" colwidth="1.18*"/>
					<colspec colname="c4" colnum="4" colwidth="9.57*"/>
					<thead>
						<row>
							<entry>Order</entry>
							<entry>Rank</entry>
							<entry>% calls in mode</entry>
							<entry>Pattern</entry>
						</row>
					</thead>
					<tbody>
						<row>
							<entry align="right">52</entry>
							<entry align="right">26</entry>
							<entry align="right">28.5</entry>
							<entry>
								<code>@C{ pr-d/codeph }</code>
							</entry>
						</row>
						<row>
							<entry align="right">204</entry>
							<entry align="right">5</entry>
							<entry align="right">25.0</entry>
							<entry>
								<code>@C{ topic/tbody }/@C{ topic/row }/@C{ topic/entry }</code>
							</entry>
						</row>
						<row>
							<entry align="right">151</entry>
							<entry align="right">9</entry>
							<entry align="right">8.5</entry>
							<entry>
								<code>@C{ topic/p }</code>
							</entry>
						</row>
						<row>
							<entry align="right">199</entry>
							<entry align="right">5</entry>
							<entry align="right">7.5</entry>
							<entry>
								<code>@C{ topic/strow }/@C{ topic/stentry }</code>
							</entry>
						</row>
						<row>
							<entry align="right">206</entry>
							<entry align="right">5</entry>
							<entry align="right">5.3</entry>
							<entry>
								<code>@C{ topic/tbody }/@C{ topic/row }</code>
							</entry>
						</row>
						<row>
							<entry align="right">205</entry>
							<entry align="right">5</entry>
							<entry align="right">5.1</entry>
							<entry>
								<code>@C{ topic/thead }/@C{ topic/row }/@C{ topic/entry }</code>
							</entry>
						</row>
						<row>
							<entry align="right">210</entry>
							<entry align="right">5</entry>
							<entry align="right">5.1</entry>
							<entry>
								<code>@C{ topic/colspec }</code>
							</entry>
						</row>
					</tbody>
				</tgroup>
			</table>
			<para>(<code>@C{ xxx }</code> is an abbreviation for <code>*[contains(@class,' xxx ')]</code>)
				Here we can see the problem - each pattern must perform 'free-position' string matching on
				an attribute of at least the element node under test and sometimes within one or even two
				ancestors. And it turns out that of these 240 template rules, <emphasis>all bar
					one</emphasis> of them have a similar form<footnote>
					<para>We are somewhat puzzled by the redundancy in representation present – table entries
						are represented both by an element <code>entry</code> and a token within
							<code>@class</code>. Are there circumstances where a table cell is
							<emphasis>not</emphasis> represented by an element <code>entry</code>? If this is not
						the case, then why use the <code>*[....]</code> pattern rather than one keyed on the
						element QName? We understand that support for extensibility of element-vocabulary was
						one reason. Far be it for the authors to criticise the design choices of DITA in its
						representation of class membership, or the DITA-OT framework for the processing
						architecture, but <emphasis>this is no way to run a railway</emphasis>. </para>
				</footnote>. So for templates whose order is 200+, more than 200 other string matches of
				very similar form have been performed, on <emphasis>every element</emphasis> processed
				through <code>xsl:apply-templates</code>
			</para>
			<para>When we look at the amount of time consumed the picture is similar.</para>
			<figure>
				<title>Pattern matching time for the most frequently matched templates</title>
				<mediaobject>
					<imageobject>
						<imagedata xmlns:xlink="http://www.w3.org/1999/xlink">
							<svg xmlns="http://www.w3.org/2000/svg" xmlns:db="http://docbook.org/ns/docbook"
								width="100%" height="100%" viewBox="0 0 1100 575">
								<desc/>
								<text x="20" y="20" font-size="10">2015-05-03T13:10:30.615+01:00</text>
								<g alignment-baseline="baseline" transform="translate(40,40)">
									<g>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="0" x2="0"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="0"
											>0</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="142.85714285714286"
											x2="142.85714285714286"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="285.7142857142857"
											x2="285.7142857142857"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="428.57142857142856"
											x2="428.57142857142856"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="571.4285714285714"
											x2="571.4285714285714"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="714.2857142857143"
											x2="714.2857142857143"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510"
											x="714.2857142857143">500</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="857.1428571428571"
											x2="857.1428571428571"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="1000" x2="1000"/>
										<text x="500" y="530" class="axis label" text-anchor="middle"
											font-family="arial" font-weight="bold" font-size="12pt"
											style="font-family:arial;font-weight:bold;font-size:12pt">Total / ms</text>
									</g>
									<g transform="translate(500,250)">
										<text class="label" x="0" y="20" font-family="arial" font-weight="bold"
											font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
											>Longest processed templates</text>
										<text class="label" x="0" y="40" font-family="arial" font-weight="bold"
											font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
											>mode:#default</text>
									</g>
									<svg x="800" y="60">
										<circle cx="5" cy="12" r="5" class="OFF" stroke="red" fill="red"
											style="stroke:red;fill:red"/>
										<text x="20" y="20" class="key label" font-family="arial" font-weight="bold"
											font-size="12pt" style="font-family:arial;font-weight:bold;font-size:12pt"
											>Normal</text>
									</svg>
									<g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="6.097560975609724"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">204:5 → @C{
												topic/tbody }/@C{ topic/row }/@C{ topic/entry }</text>
											<line class="OFF total" x1="0" x2="878.6806825" y1="12.195121951219505"
												y2="12.195121951219505" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="54.8780487804878"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">52:26 → @C{
												pr-d/codeph }</text>
											<line class="OFF total" x1="0" x2="297.9443275" y1="60.97560975609758"
												y2="60.97560975609758" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="103.65853658536582"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">151:9 → @C{ topic/p
												}</text>
											<line class="OFF total" x1="0" x2="279.14133964285713" y1="109.7560975609756"
												y2="109.7560975609756" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="152.4390243902439"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">199:5 → @C{
												topic/strow }/@C{ topic/stentry }</text>
											<line class="OFF total" x1="0" x2="277.9851857142857" y1="158.53658536585363"
												y2="158.53658536585363" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="201.21951219512192"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">206:5 → @C{
												topic/tbody }/@C{ topic/row }</text>
											<line class="OFF total" x1="0" x2="184.17469285714287" y1="207.3170731707317"
												y2="207.3170731707317" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="250" font-family="arial"
												font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">210:5 → @C{
												topic/colspec }</text>
											<line class="OFF total" x1="0" x2="183.33999035714285" y1="256.0975609756098"
												y2="256.0975609756098" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="298.780487804878"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">205:5 → @C{
												topic/thead }/@C{ topic/row }/@C{ topic/entry }</text>
											<line class="OFF total" x1="0" x2="182.9328492857143" y1="304.8780487804878"
												y2="304.8780487804878" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="347.5609756097561"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">201:5 → @C{
												topic/strow }</text>
											<line class="OFF total" x1="0" x2="138.33878" y1="353.6585365853658"
												y2="353.6585365853658" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="396.3414634146342"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">213:5 → @C{
												topic/table }</text>
											<line class="OFF total" x1="0" x2="41.56523607142857" y1="402.4390243902439"
												y2="402.4390243902439" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="445.1219512195122"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">207:5 → @C{
												topic/thead }/@C{ topic/row }</text>
											<line class="OFF total" x1="0" x2="40.27045535714286" y1="451.219512195122"
												y2="451.219512195122" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
										</g>
									</g>
								</g>
							</svg>
						</imagedata>
					</imageobject>
				</mediaobject>
			</figure>
			<para>Given the architecture where class membership is described in the <code>@class</code>
				attribute, an obvious question is whether in practice elements can be members of multiple
				classes. The input clearly shows this to be so – 3,864 of the 13,066 elements have multiple
				class <quote>tokens</quote>, the vast majority being <code>- topic/ph pr-d/codeph</code>,
				which according to the DITA reference, declares that the given element is a structural
				element equivalent to both a phrase in a generic topic and a code-phrase in a programming
				domain. </para>
			<para>Clearly for this type of stylesheet the issue is that very many of the templates, being
				processed independently, have to carry out the same sort of operation multiple times on the
				same node. What methods might be available to reduce the processing, preferably to a
				minimum? In the rest of this paper we discuss some possible improvements of the following
				general types:</para>
			<itemizedlist>
				<listitem>
					<para>Rule preconditions: determining common boolean preconditions that must be satisfied
						for a (large) number of rules to possibly match – the results for a specific node can be
						cached and rules that are bound to fail can be excluded rapidly. These approaches have
						the property that they are <emphasis>heuristic</emphasis> in performance improvement but
						retain correct stylesheet behaviour.</para>
				</listitem>
				<listitem>
					<para>Other methods that require <emphasis>oracle</emphasis> guarantees about the
						stylesheet behaviour, effectively allowing short-cuts which are not generally applicable
						to all stylesheets. The cases include: </para>
					<itemizedlist>
						<listitem>
							<para>Suspending rule ambiguity checking, and potential template/stylesheet
								reordering.</para>
						</listitem>
						<listitem>
							<para>Pre-tokenizing suitable properties: exploiting higher-level knowledge in
								replacing patterns with access to deeper structure.</para>
						</listitem>
						<listitem>
							<para>Using <code>key()</code> structures.</para>
						</listitem>
					</itemizedlist>
				</listitem>
			</itemizedlist>
		</sect2>
	</sect1>
	<sect1>
		<title>Preconditions</title>
		<para>With long sequences of patterns, many of which have some similarities, one possibility is
			to detemine a smaller set of precondition patterns that can be tested as required for a node
			before the <quote>main</quote> pattern is checked. The value of such a precondition for a
			given node can be computed only when required (i.e. the first time when a pattern that uses
			that precondition has to be checked) and stored to avoid subsequent recomputation. The hope of
			course is to eliminate quickly higher-rank patterns that cannot match as one or more of their
			preconditions has already been determined to fail. For example if there were a large set of
			templates with matches of the form <code>chapter/</code>
			<emphasis>
				<code>node-condition</code>
			</emphasis>, such as:</para>
		<programlisting>chapter/title[<emphasis>condition1</emphasis>],
chapter/title[<emphasis>condition2</emphasis>], 
chapter/para,  chapter/section ...</programlisting>
		<para>then they all share the requirement that <code>exists(parent::chapter)</code> must be true
			for the pattern to match. Thus computing whether this precondition is satisfied for a given
			node <emphasis>once</emphasis> may aid performance in several possible ways:</para>
		<itemizedlist>
			<listitem>
				<para>If a node does <emphasis>not</emphasis> have a <code>chapter</code> parent, then this
					need be determined only <emphasis>once</emphasis> for the node and each of these templates
					can be ruled out immediately.</para>
			</listitem>
			<listitem>
				<para>The pattern might be partially-evaluated within the context that the precondition is
					true, e.g. precondition(<code>exists(parent::chapter)</code>) reduces the patterns to </para>
				<programlisting>precondition:exists(parent::chapter) :
   title[<emphasis>condition1</emphasis>], title[<emphasis>condition2</emphasis>],
   para,  section ...</programlisting>
			</listitem>
		</itemizedlist>
		<para>In our DITA example, using <code>exists(@class)</code> will gain us little – almost every
			element in a DITA document has a <code>@class</code> attribute and 90% of all element matches
			predicate upon it. We could choose to use the <code>contains(@class,...)</code> as a more
			discriminating condition. Of the 239 template rules that share that test for the context item
			(the node under test within <code>xsl:apply-templates</code>) there are 204 distinct values
			for the check (the largest common set has just 7 members, most have of course 1). </para>
		<para>In some cases these preconditions might be common, especially when tested on ancestor
			nodes. For example rules #204 and #205 both test for <code>topic/entry</code> on the element
			and <code>topic/row</code> on the parent, differing only whether the grandparent is a table
			body or head. In this case, and especially with our sample document which is
				<emphasis>very</emphasis> table heavy, the precondition <quote>pair</quote>
			<code>contains(@class,' topic/entry ') and contains(../@class, ' table/row ')</code> might be
			beneficial (tested on #204, but result available for #205), but it is admittedly a very
			special case. What other more general preconditions might be useful? </para>
		<para>A necessary precondition for <code>contains(@class,<phrase>string</phrase>)</code> is
					<code>contains(@class,<phrase>any-substring-of(string)</phrase>)</code> so some expression
			of this form might be useful. Choosing to use just the first character of the comparator
			string, which might normally be expected to be of some use in many cases, fails miserably
			here, as due to the class representation model being used within DITA-OT, a leading space is
			appended to the class token comparand (effectively implementing an equivalent of
				<code>tokenize(@class,'\s+') = 'entity-class'</code>) – no gain there then. </para>
		<para>If we choose to use the first two characters, we get 12 different preconditions, three of
			which apply to a <code>parent::*</code> context. The distribution of the use of these
			preconditions across the rule order is shown in <xref linkend="fig.substring2.pre"/>:</para>
		<figure xml:id="fig.substring2.pre">
			<title>Distribution of 2 character initial substring preconditions</title>
			<mediaobject>
				<imageobject>
					<imagedata xmlns:xlink="http://www.w3.org/1999/xlink">
						<svg xmlns="http://www.w3.org/2000/svg" xmlns:db="http://docbook.org/ns/docbook"
							width="100%" height="100%" viewBox="0 0 1100 575">
							<desc/>
							<text x="20" y="20" font-size="10">2015-04-18T14:18:40.518+01:00</text>
							<g alignment-baseline="baseline" transform="translate(40,40)">
								<g>
									<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="500" y2="500"/>
									<text class="axis" font-size="10" text-anchor="end" x="0" y="500">0</text>
									<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="461.53846153846155"
										y2="461.53846153846155"/>
									<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="423.0769230769231"
										y2="423.0769230769231"/>
									<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="384.61538461538464"
										y2="384.61538461538464"/>
									<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="346.1538461538462"
										y2="346.1538461538462"/>
									<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="307.69230769230774"
										y2="307.69230769230774"/>
									<text class="axis" font-size="10" text-anchor="end" x="0" y="307.69230769230774"
										>5</text>
									<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="269.2307692307692"
										y2="269.2307692307692"/>
									<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="230.76923076923077"
										y2="230.76923076923077"/>
									<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="192.30769230769232"
										y2="192.30769230769232"/>
									<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="153.84615384615387"
										y2="153.84615384615387"/>
									<line stroke="grey" stroke-width="1" x1="0" x2="1000" y1="115.38461538461542"
										y2="115.38461538461542"/>
									<text class="axis" font-size="10" text-anchor="end" x="0" y="115.38461538461542"
										>10</text>
									<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="76.92307692307696"
										y2="76.92307692307696"/>
									<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="38.46153846153845"
										y2="38.46153846153845"/>
									<line stroke="grey" stroke-width="0.5" x1="0" x2="1000" y1="0" y2="0"/>
									<text transform="rotate(-90,-10,250)" y="250" x="-10" class="axis label"
										text-anchor="middle" font-family="arial" font-weight="bold" font-size="12pt"
										style="font-family:arial;font-weight:bold;font-size:12pt">Precondition #</text>
								</g>
								<g>
									<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="0" x2="0"/>
									<text class="axis value" text-anchor="middle" font-size="10" y="510" x="0"
										>0</text>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="40" x2="40"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="80" x2="80"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="120" x2="120"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="160" x2="160"/>
									<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="200" x2="200"/>
									<text class="axis value" text-anchor="middle" font-size="10" y="510" x="200"
										>50</text>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="240" x2="240"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="280" x2="280"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="320" x2="320"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="360" x2="360"/>
									<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="400" x2="400"/>
									<text class="axis value" text-anchor="middle" font-size="10" y="510" x="400"
										>100</text>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="440" x2="440"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="480" x2="480"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="520" x2="520"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="560" x2="560"/>
									<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="600" x2="600"/>
									<text class="axis value" text-anchor="middle" font-size="10" y="510" x="600"
										>150</text>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="640" x2="640"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="680" x2="680"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="720" x2="720"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="760" x2="760"/>
									<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="800" x2="800"/>
									<text class="axis value" text-anchor="middle" font-size="10" y="510" x="800"
										>200</text>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="840" x2="840"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="880" x2="880"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="920" x2="920"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="960" x2="960"/>
									<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="1000" x2="1000"/>
									<text class="axis value" text-anchor="middle" font-size="10" y="510" x="1000"
										>250</text>
									<text x="500" y="520" class="axis label" text-anchor="middle" font-family="arial"
										font-weight="bold" font-size="12pt"
										style="font-family:arial;font-weight:bold;font-size:12pt">Rule order</text>
								</g>
								<g transform="translate(500,40)">
									<text class="label" x="0" y="20" font-family="arial" font-weight="bold"
										font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
										>Precondition distribution</text>
									<text class="label" x="0" y="40" font-family="arial" font-weight="bold"
										font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
										>mode:#default</text>
									<text class="label" x="0" y="60" font-family="arial" font-weight="bold"
										font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
										>2-character initial substring</text>
								</g>
								<g>
									<text class="match" x="8" y="223.0769230769231" font-family="arial"
										font-size="9pt" font-weight="bold"
										style="font-family:arial;font-size:9pt;font-weight:bold">@C{ s}</text>
									<text class="match" x="8" y="107.69230769230774" font-family="arial"
										font-size="9pt" font-weight="bold"
										style="font-family:arial;font-size:9pt;font-weight:bold">@C{ b}</text>
									<text class="match" x="8" y="184.61538461538464" font-family="arial"
										font-size="9pt" font-weight="bold"
										style="font-family:arial;font-size:9pt;font-weight:bold">@C{ r}</text>
									<text class="match" x="8" y="415.38461538461536" font-family="arial"
										font-size="9pt" font-weight="bold"
										style="font-family:arial;font-size:9pt;font-weight:bold">@C{ p}</text>
									<text class="match" x="8" y="261.53846153846155" font-family="arial"
										font-size="9pt" font-weight="bold"
										style="font-family:arial;font-size:9pt;font-weight:bold">@C{ u}</text>
									<text class="match" x="8" y="453.84615384615387" font-family="arial"
										font-size="9pt" font-weight="bold"
										style="font-family:arial;font-size:9pt;font-weight:bold">@C{ t}</text>
									<text class="match" x="8" y="376.9230769230769" font-family="arial"
										font-size="9pt" font-weight="bold"
										style="font-family:arial;font-size:9pt;font-weight:bold">parent::@C{ t}</text>
									<text class="match" x="8" y="146.1538461538462" font-family="arial"
										font-size="9pt" font-weight="bold"
										style="font-family:arial;font-size:9pt;font-weight:bold">@C{ h}</text>
									<text class="match" x="8" y="69.23076923076928" font-family="arial"
										font-size="9pt" font-weight="bold"
										style="font-family:arial;font-size:9pt;font-weight:bold">@C{ x}</text>
									<text class="match" x="8" y="30.76923076923083" font-family="arial"
										font-size="9pt" font-weight="bold"
										style="font-family:arial;font-size:9pt;font-weight:bold">parent::@C{ m}</text>
									<text class="match" x="8" y="300" font-family="arial" font-size="9pt"
										font-weight="bold" style="font-family:arial;font-size:9pt;font-weight:bold"
										>parent::@C{ p}</text>
									<text class="match" x="8" y="338.46153846153845" font-family="arial"
										font-size="9pt" font-weight="bold"
										style="font-family:arial;font-size:9pt;font-weight:bold">@C{ m}</text>
									<circle class="pre" cx="16" cy="269.2307692307692" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="20" cy="269.2307692307692" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="24" cy="269.2307692307692" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="28" cy="269.2307692307692" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="32" cy="269.2307692307692" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="36" cy="153.84615384615387" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="40" cy="153.84615384615387" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="44" cy="153.84615384615387" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="48" cy="153.84615384615387" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="52" cy="153.84615384615387" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="56" cy="153.84615384615387" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="60" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="60" cy="307.69230769230774" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="64" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="64" cy="307.69230769230774" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="68" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="68" cy="307.69230769230774" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="72" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="72" cy="307.69230769230774" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="76" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="76" cy="307.69230769230774" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="80" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="80" cy="307.69230769230774" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="84" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="84" cy="307.69230769230774" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="88" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="88" cy="307.69230769230774" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="92" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="92" cy="307.69230769230774" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="120" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="120" cy="307.69230769230774" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="124" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="128" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="132" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="132" cy="307.69230769230774" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="136" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="140" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="144" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="148" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="152" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="156" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="160" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="164" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="168" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="172" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="176" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="180" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="184" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="188" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="192" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="196" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="200" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="204" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="208" cy="423.0769230769231" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="212" cy="230.76923076923077" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="216" cy="230.76923076923077" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="220" cy="230.76923076923077" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="224" cy="230.76923076923077" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="228" cy="230.76923076923077" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="232" cy="230.76923076923077" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="236" cy="230.76923076923077" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="240" cy="230.76923076923077" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="244" cy="192.30769230769232" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="248" cy="192.30769230769232" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="252" cy="192.30769230769232" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="256" cy="192.30769230769232" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="260" cy="192.30769230769232" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="264" cy="192.30769230769232" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="268" cy="192.30769230769232" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="272" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="276" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="276" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="280" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="280" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="284" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="284" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="288" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="288" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="292" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="296" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="300" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="304" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="308" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="312" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="312" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="316" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="320" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="324" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="324" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="328" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="328" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="332" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="336" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="340" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="344" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="348" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="348" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="352" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="356" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="360" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="364" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="368" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="372" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="376" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="380" cy="346.1538461538462" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="384" cy="346.1538461538462" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="388" cy="346.1538461538462" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="392" cy="346.1538461538462" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="396" cy="38.46153846153845" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="396" cy="346.1538461538462" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="400" cy="346.1538461538462" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="404" cy="38.46153846153845" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="404" cy="346.1538461538462" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="408" cy="115.38461538461542" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="412" cy="115.38461538461542" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="416" cy="115.38461538461542" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="420" cy="115.38461538461542" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="424" cy="115.38461538461542" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="428" cy="76.92307692307696" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="432" cy="76.92307692307696" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="436" cy="76.92307692307696" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="440" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="444" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="448" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="452" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="456" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="460" cy="346.1538461538462" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="464" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="476" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="476" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="484" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="488" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="492" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="496" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="500" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="504" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="508" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="512" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="516" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="520" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="524" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="528" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="532" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="536" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="540" cy="269.2307692307692" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="544" cy="269.2307692307692" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="548" cy="269.2307692307692" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="552" cy="269.2307692307692" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="556" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="560" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="564" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="568" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="572" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="576" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="580" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="584" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="588" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="592" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="596" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="600" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="604" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="608" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="612" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="616" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="620" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="624" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="628" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="632" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="636" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="640" cy="346.1538461538462" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="644" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="648" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="660" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="664" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="668" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="672" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="676" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="680" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="684" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="688" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="692" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="696" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="700" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="704" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="708" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="712" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="716" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="720" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="724" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="728" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="732" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="736" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="740" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="744" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="748" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="752" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="756" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="760" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="764" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="768" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="772" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="776" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="776" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="780" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="780" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="784" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="784" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="788" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="788" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="792" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="796" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="796" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="800" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="800" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="804" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="808" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="812" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="816" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="820" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="824" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="824" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="828" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="828" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="832" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="836" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="840" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="844" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="848" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="848" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="852" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="856" cy="346.1538461538462" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="860" cy="346.1538461538462" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="864" cy="346.1538461538462" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="868" cy="346.1538461538462" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="872" cy="38.46153846153845" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="872" cy="346.1538461538462" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="876" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="880" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="884" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="888" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="888" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="892" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="892" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="896" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="896" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="900" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="904" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="904" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="908" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="912" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="912" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="916" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="916" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="920" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="920" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="924" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="928" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="932" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="932" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="936" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="940" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="940" cy="384.61538461538464" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="944" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="948" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="952" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="956" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="960" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="964" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
									<circle class="pre" cx="968" cy="461.53846153846155" r="2" fill="red"
										style="fill:red"/>
								</g>
							</g>
						</svg>
					</imagedata>
					<!--<imagedata width="20cm" depth="12cm"
                            fileref="../../../tests/john/dita/ATests/svg/substring/modes/saxon-defaultMode/pre.svg"
                            format="SVG"/>-->
				</imageobject>
			</mediaobject>
		</figure>
		<para>Note that these preconditions are not mutually exclusive – some of the compound cases
			involve two conditions, one on the context element and the other on its parent. This is the
			case for 43% of the element template matches on the sample document. By changing the
			fixed-length initial substrings used we get a variety of balances between precondition group
			sizes:</para>
		<table frame="all">
			<title>Precondition group sizes as a function of initial substring discriminant</title>
			<tgroup cols="3">
				<colspec colname="c1" colnum="1" colwidth="1.03*"/>
				<colspec colname="c2" colnum="2" colwidth="1*"/>
				<colspec colname="c3" colnum="3" colwidth="2.21*"/>
				<thead>
					<row>
						<entry align="center">Substring length</entry>
						<entry align="center"># preconditions</entry>
						<entry align="center">Largest reference set</entry>
					</row>
				</thead>
				<tbody>
					<row>
						<entry align="right">2</entry>
						<entry align="right">12</entry>
						<entry align="right">146</entry>
					</row>
					<row>
						<entry align="right">3 - 5</entry>
						<entry align="right">14</entry>
						<entry align="right">121</entry>
					</row>
					<row>
						<entry align="right">6</entry>
						<entry align="right">16</entry>
						<entry align="right">121</entry>
					</row>
					<row>
						<entry align="right">7</entry>
						<entry align="right">46</entry>
						<entry align="right">121</entry>
					</row>
					<row>
						<entry align="right">8</entry>
						<entry align="right">75</entry>
						<entry align="right">17</entry>
					</row>
				</tbody>
			</tgroup>
		</table>
		<para>We can modify our applicable rule search such that each rule has a set of required
			preconditions (described by a list of indices into a cache of expressions and boolean values)
			which are tested before the main match is then processed. The rest of the rule list processing
			machinery is unaltered. The effect on the performance is shown in <xref
				linkend="fig.substring"/>:</para>
		<figure xml:id="fig.substring">
			<title>Effect of differing substring preconditions</title>
			<mediaobject>
				<imageobject>
					<imagedata xmlns:xlink="http://www.w3.org/1999/xlink">
						<svg xmlns="http://www.w3.org/2000/svg" xmlns:db="http://docbook.org/ns/docbook"
							width="100%" height="100%" viewBox="0 0 1100 575">
							<desc/>
							<text x="20" y="20" font-size="10">2015-04-20T15:38:06.241+01:00</text>
							<g alignment-baseline="baseline" transform="translate(40,40)">
								<g>
									<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="0" x2="0"/>
									<text class="axis value" text-anchor="middle" font-size="10" y="510" x="0"
										>0</text>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="142.85714285714286"
										x2="142.85714285714286"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="285.7142857142857"
										x2="285.7142857142857"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="428.57142857142856"
										x2="428.57142857142856"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="571.4285714285714"
										x2="571.4285714285714"/>
									<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="714.2857142857143"
										x2="714.2857142857143"/>
									<text class="axis value" text-anchor="middle" font-size="10" y="510"
										x="714.2857142857143">500</text>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="857.1428571428571"
										x2="857.1428571428571"/>
									<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="1000" x2="1000"/>
									<text x="500" y="520" class="axis label" text-anchor="middle" font-family="arial"
										font-weight="bold" font-size="12pt"
										style="font-family:arial;font-weight:bold;font-size:12pt">Total / ms</text>
								</g>
								<g transform="translate(500,250)">
									<text class="label" x="0" y="20" font-family="arial" font-weight="bold"
										font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
										>Longest processed templates</text>
									<text class="label" x="0" y="40" font-family="arial" font-weight="bold"
										font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
										>mode:#default</text>
								</g>
								<svg x="800" y="60">
									<circle cx="5" cy="12" r="5" class="OFF" stroke="red" fill="red"
										style="stroke:red;fill:red"/>
									<text x="20" y="20" class="key label" font-family="arial" font-weight="bold"
										font-size="12pt" style="font-family:arial;font-weight:bold;font-size:12pt"
										>Normal</text>
									<circle cx="5" cy="32" r="5" class="ON2" stroke="green" fill="green"
										style="stroke:green;fill:green"/>
									<text x="20" y="40" class="key label" font-family="arial" font-weight="bold"
										font-size="12pt" style="font-family:arial;font-weight:bold;font-size:12pt"
										>2-character initial substring</text>
									<circle cx="5" cy="52" r="5" class="ON3" stroke="brown" fill="brown"
										style="stroke:brown;fill:brown"/>
									<text x="20" y="60" class="key label" font-family="arial" font-weight="bold"
										font-size="12pt" style="font-family:arial;font-weight:bold;font-size:12pt"
										>3-character initial substring</text>
									<circle cx="5" cy="72" r="5" class="ON8" stroke="blue" fill="blue"
										style="stroke:blue;fill:blue"/>
									<text x="20" y="80" class="key label" font-family="arial" font-weight="bold"
										font-size="12pt" style="font-family:arial;font-weight:bold;font-size:12pt"
										>8-character initial substring</text>
									<circle cx="5" cy="92" r="5" class="ON3END" stroke="orange" fill="orange"
										style="stroke:orange;fill:orange"/>
									<text x="20" y="100" class="key label" font-family="arial" font-weight="bold"
										font-size="12pt" style="font-family:arial;font-weight:bold;font-size:12pt"
										>3-character terminal substring</text>
								</svg>
								<g>
									<g>
										<text class="match" x="0.0000028571428571428573" y="6.097560975609724"
											font-family="arial" font-size="9pt" font-weight="bold"
											style="font-family:arial;font-size:9pt;font-weight:bold">204:5 → @C{
											topic/tbody }/@C{ topic/row }/@C{ topic/entry }</text>
										<line class="OFF total" x1="0" x2="878.6806825" y1="12.195121951219505"
											y2="12.195121951219505" stroke="red" fill="red" stroke-width="3pt"
											style="stroke:red;fill:red;stroke-width:3pt"/>
										<line class="ON2 total" x1="0" x2="684.2358642857143" y1="18.292682926829286"
											y2="18.292682926829286" stroke="green" fill="green" stroke-width="3pt"
											style="stroke:green;fill:green;stroke-width:3pt"/>
										<line class="ON3 total" x1="0" x2="719.0648282142857" y1="24.39024390243901"
											y2="24.39024390243901" stroke="brown" fill="brown" stroke-width="3pt"
											style="stroke:brown;fill:brown;stroke-width:3pt"/>
										<line class="ON8 total" x1="0" x2="492.27799000000005" y1="30.48780487804879"
											y2="30.48780487804879" stroke="blue" fill="blue" stroke-width="3pt"
											style="stroke:blue;fill:blue;stroke-width:3pt"/>
										<line class="ON3END total" x1="0" x2="562.0341625" y1="36.585365853658516"
											y2="36.585365853658516" stroke="orange" fill="orange" stroke-width="3pt"
											style="stroke:orange;fill:orange;stroke-width:3pt"/>
									</g>
									<g>
										<text class="match" x="0.0000028571428571428573" y="54.8780487804878"
											font-family="arial" font-size="9pt" font-weight="bold"
											style="font-family:arial;font-size:9pt;font-weight:bold">52:26 → @C{
											pr-d/codeph }</text>
										<line class="OFF total" x1="0" x2="297.9443275" y1="60.97560975609758"
											y2="60.97560975609758" stroke="red" fill="red" stroke-width="3pt"
											style="stroke:red;fill:red;stroke-width:3pt"/>
										<line class="ON2 total" x1="0" x2="231.53567071428571" y1="67.07317073170731"
											y2="67.07317073170731" stroke="green" fill="green" stroke-width="3pt"
											style="stroke:green;fill:green;stroke-width:3pt"/>
										<line class="ON3 total" x1="0" x2="265.9221867857143" y1="73.17073170731709"
											y2="73.17073170731709" stroke="brown" fill="brown" stroke-width="3pt"
											style="stroke:brown;fill:brown;stroke-width:3pt"/>
										<line class="ON8 total" x1="0" x2="236.99598071428574" y1="79.26829268292681"
											y2="79.26829268292681" stroke="blue" fill="blue" stroke-width="3pt"
											style="stroke:blue;fill:blue;stroke-width:3pt"/>
										<line class="ON3END total" x1="0" x2="270.19035214285714" y1="85.3658536585366"
											y2="85.3658536585366" stroke="orange" fill="orange" stroke-width="3pt"
											style="stroke:orange;fill:orange;stroke-width:3pt"/>
									</g>
									<g>
										<text class="match" x="0.0000028571428571428573" y="103.65853658536582"
											font-family="arial" font-size="9pt" font-weight="bold"
											style="font-family:arial;font-size:9pt;font-weight:bold">151:9 → @C{ topic/p
											}</text>
										<line class="OFF total" x1="0" x2="279.14133964285713" y1="109.7560975609756"
											y2="109.7560975609756" stroke="red" fill="red" stroke-width="3pt"
											style="stroke:red;fill:red;stroke-width:3pt"/>
										<line class="ON2 total" x1="0" x2="199.71080714285716" y1="115.85365853658539"
											y2="115.85365853658539" stroke="green" fill="green" stroke-width="3pt"
											style="stroke:green;fill:green;stroke-width:3pt"/>
										<line class="ON3 total" x1="0" x2="196.48722142857144" y1="121.95121951219511"
											y2="121.95121951219511" stroke="brown" fill="brown" stroke-width="3pt"
											style="stroke:brown;fill:brown;stroke-width:3pt"/>
										<line class="ON8 total" x1="0" x2="178.37115892857145" y1="128.0487804878049"
											y2="128.0487804878049" stroke="blue" fill="blue" stroke-width="3pt"
											style="stroke:blue;fill:blue;stroke-width:3pt"/>
										<line class="ON3END total" x1="0" x2="172.71108" y1="134.14634146341461"
											y2="134.14634146341461" stroke="orange" fill="orange" stroke-width="3pt"
											style="stroke:orange;fill:orange;stroke-width:3pt"/>
									</g>
									<g>
										<text class="match" x="0.0000028571428571428573" y="152.4390243902439"
											font-family="arial" font-size="9pt" font-weight="bold"
											style="font-family:arial;font-size:9pt;font-weight:bold">199:5 → @C{
											topic/strow }/@C{ topic/stentry }</text>
										<line class="OFF total" x1="0" x2="277.9851857142857" y1="158.53658536585363"
											y2="158.53658536585363" stroke="red" fill="red" stroke-width="3pt"
											style="stroke:red;fill:red;stroke-width:3pt"/>
										<line class="ON2 total" x1="0" x2="206.43265785714286" y1="164.6341463414634"
											y2="164.6341463414634" stroke="green" fill="green" stroke-width="3pt"
											style="stroke:green;fill:green;stroke-width:3pt"/>
										<line class="ON3 total" x1="0" x2="209.0916560714286" y1="170.7317073170732"
											y2="170.7317073170732" stroke="brown" fill="brown" stroke-width="3pt"
											style="stroke:brown;fill:brown;stroke-width:3pt"/>
										<line class="ON8 total" x1="0" x2="153.10821857142858" y1="176.8292682926829"
											y2="176.8292682926829" stroke="blue" fill="blue" stroke-width="3pt"
											style="stroke:blue;fill:blue;stroke-width:3pt"/>
										<line class="ON3END total" x1="0" x2="170.24407464285716" y1="182.9268292682927"
											y2="182.9268292682927" stroke="orange" fill="orange" stroke-width="3pt"
											style="stroke:orange;fill:orange;stroke-width:3pt"/>
									</g>
									<g>
										<text class="match" x="0.0000028571428571428573" y="201.21951219512192"
											font-family="arial" font-size="9pt" font-weight="bold"
											style="font-family:arial;font-size:9pt;font-weight:bold">206:5 → @C{
											topic/tbody }/@C{ topic/row }</text>
										<line class="OFF total" x1="0" x2="184.17469285714287" y1="207.3170731707317"
											y2="207.3170731707317" stroke="red" fill="red" stroke-width="3pt"
											style="stroke:red;fill:red;stroke-width:3pt"/>
										<line class="ON2 total" x1="0" x2="143.82198607142857" y1="213.41463414634148"
											y2="213.41463414634148" stroke="green" fill="green" stroke-width="3pt"
											style="stroke:green;fill:green;stroke-width:3pt"/>
										<line class="ON3 total" x1="0" x2="151.8379667857143" y1="219.5121951219512"
											y2="219.5121951219512" stroke="brown" fill="brown" stroke-width="3pt"
											style="stroke:brown;fill:brown;stroke-width:3pt"/>
										<line class="ON8 total" x1="0" x2="107.02554035714286" y1="225.609756097561"
											y2="225.609756097561" stroke="blue" fill="blue" stroke-width="3pt"
											style="stroke:blue;fill:blue;stroke-width:3pt"/>
										<line class="ON3END total" x1="0" x2="117.4599125" y1="231.7073170731707"
											y2="231.7073170731707" stroke="orange" fill="orange" stroke-width="3pt"
											style="stroke:orange;fill:orange;stroke-width:3pt"/>
									</g>
									<g>
										<text class="match" x="0.0000028571428571428573" y="250" font-family="arial"
											font-size="9pt" font-weight="bold"
											style="font-family:arial;font-size:9pt;font-weight:bold">210:5 → @C{
											topic/colspec }</text>
										<line class="OFF total" x1="0" x2="183.33999035714285" y1="256.0975609756098"
											y2="256.0975609756098" stroke="red" fill="red" stroke-width="3pt"
											style="stroke:red;fill:red;stroke-width:3pt"/>
										<line class="ON2 total" x1="0" x2="139.09375285714287" y1="262.1951219512195"
											y2="262.1951219512195" stroke="green" fill="green" stroke-width="3pt"
											style="stroke:green;fill:green;stroke-width:3pt"/>
										<line class="ON3 total" x1="0" x2="141.72021714285714" y1="268.29268292682923"
											y2="268.29268292682923" stroke="brown" fill="brown" stroke-width="3pt"
											style="stroke:brown;fill:brown;stroke-width:3pt"/>
										<line class="ON8 total" x1="0" x2="107.29867214285714" y1="274.390243902439"
											y2="274.390243902439" stroke="blue" fill="blue" stroke-width="3pt"
											style="stroke:blue;fill:blue;stroke-width:3pt"/>
										<line class="ON3END total" x1="0" x2="112.00147214285715" y1="280.4878048780488"
											y2="280.4878048780488" stroke="orange" fill="orange" stroke-width="3pt"
											style="stroke:orange;fill:orange;stroke-width:3pt"/>
									</g>
									<g>
										<text class="match" x="0.0000028571428571428573" y="298.780487804878"
											font-family="arial" font-size="9pt" font-weight="bold"
											style="font-family:arial;font-size:9pt;font-weight:bold">205:5 → @C{
											topic/thead }/@C{ topic/row }/@C{ topic/entry }</text>
										<line class="OFF total" x1="0" x2="182.9328492857143" y1="304.8780487804878"
											y2="304.8780487804878" stroke="red" fill="red" stroke-width="3pt"
											style="stroke:red;fill:red;stroke-width:3pt"/>
										<line class="ON2 total" x1="0" x2="141.09837142857143" y1="310.9756097560976"
											y2="310.9756097560976" stroke="green" fill="green" stroke-width="3pt"
											style="stroke:green;fill:green;stroke-width:3pt"/>
										<line class="ON3 total" x1="0" x2="143.14698821428573" y1="317.0731707317073"
											y2="317.0731707317073" stroke="brown" fill="brown" stroke-width="3pt"
											style="stroke:brown;fill:brown;stroke-width:3pt"/>
										<line class="ON8 total" x1="0" x2="101.19797357142858" y1="323.17073170731703"
											y2="323.17073170731703" stroke="blue" fill="blue" stroke-width="3pt"
											style="stroke:blue;fill:blue;stroke-width:3pt"/>
										<line class="ON3END total" x1="0" x2="115.89339964285715" y1="329.2682926829268"
											y2="329.2682926829268" stroke="orange" fill="orange" stroke-width="3pt"
											style="stroke:orange;fill:orange;stroke-width:3pt"/>
									</g>
									<g>
										<text class="match" x="0.0000028571428571428573" y="347.5609756097561"
											font-family="arial" font-size="9pt" font-weight="bold"
											style="font-family:arial;font-size:9pt;font-weight:bold">201:5 → @C{
											topic/strow }</text>
										<line class="OFF total" x1="0" x2="138.33878" y1="353.6585365853658"
											y2="353.6585365853658" stroke="red" fill="red" stroke-width="3pt"
											style="stroke:red;fill:red;stroke-width:3pt"/>
										<line class="ON2 total" x1="0" x2="101.01673107142858" y1="359.7560975609756"
											y2="359.7560975609756" stroke="green" fill="green" stroke-width="3pt"
											style="stroke:green;fill:green;stroke-width:3pt"/>
										<line class="ON3 total" x1="0" x2="102.942295" y1="365.8536585365854"
											y2="365.8536585365854" stroke="brown" fill="brown" stroke-width="3pt"
											style="stroke:brown;fill:brown;stroke-width:3pt"/>
										<line class="ON8 total" x1="0" x2="75.67174857142858" y1="371.9512195121951"
											y2="371.9512195121951" stroke="blue" fill="blue" stroke-width="3pt"
											style="stroke:blue;fill:blue;stroke-width:3pt"/>
										<line class="ON3END total" x1="0" x2="83.33508642857143" y1="378.0487804878049"
											y2="378.0487804878049" stroke="orange" fill="orange" stroke-width="3pt"
											style="stroke:orange;fill:orange;stroke-width:3pt"/>
									</g>
									<g>
										<text class="match" x="0.0000028571428571428573" y="396.3414634146342"
											font-family="arial" font-size="9pt" font-weight="bold"
											style="font-family:arial;font-size:9pt;font-weight:bold">213:5 → @C{
											topic/table }</text>
										<line class="OFF total" x1="0" x2="41.56523607142857" y1="402.4390243902439"
											y2="402.4390243902439" stroke="red" fill="red" stroke-width="3pt"
											style="stroke:red;fill:red;stroke-width:3pt"/>
										<line class="ON2 total" x1="0" x2="32.28977857142857" y1="408.5365853658536"
											y2="408.5365853658536" stroke="green" fill="green" stroke-width="3pt"
											style="stroke:green;fill:green;stroke-width:3pt"/>
										<line class="ON3 total" x1="0" x2="32.47353392857143" y1="414.6341463414634"
											y2="414.6341463414634" stroke="brown" fill="brown" stroke-width="3pt"
											style="stroke:brown;fill:brown;stroke-width:3pt"/>
										<line class="ON8 total" x1="0" x2="25.873109642857145" y1="420.7317073170732"
											y2="420.7317073170732" stroke="blue" fill="blue" stroke-width="3pt"
											style="stroke:blue;fill:blue;stroke-width:3pt"/>
										<line class="ON3END total" x1="0" x2="29.110879285714287" y1="426.8292682926829"
											y2="426.8292682926829" stroke="orange" fill="orange" stroke-width="3pt"
											style="stroke:orange;fill:orange;stroke-width:3pt"/>
									</g>
									<g>
										<text class="match" x="0.0000028571428571428573" y="445.1219512195122"
											font-family="arial" font-size="9pt" font-weight="bold"
											style="font-family:arial;font-size:9pt;font-weight:bold">207:5 → @C{
											topic/thead }/@C{ topic/row }</text>
										<line class="OFF total" x1="0" x2="40.27045535714286" y1="451.219512195122"
											y2="451.219512195122" stroke="red" fill="red" stroke-width="3pt"
											style="stroke:red;fill:red;stroke-width:3pt"/>
										<line class="ON2 total" x1="0" x2="28.785291785714286" y1="457.3170731707317"
											y2="457.3170731707317" stroke="green" fill="green" stroke-width="3pt"
											style="stroke:green;fill:green;stroke-width:3pt"/>
										<line class="ON3 total" x1="0" x2="29.86540142857143" y1="463.4146341463415"
											y2="463.4146341463415" stroke="brown" fill="brown" stroke-width="3pt"
											style="stroke:brown;fill:brown;stroke-width:3pt"/>
										<line class="ON8 total" x1="0" x2="21.528654285714286" y1="469.5121951219512"
											y2="469.5121951219512" stroke="blue" fill="blue" stroke-width="3pt"
											style="stroke:blue;fill:blue;stroke-width:3pt"/>
										<line class="ON3END total" x1="0" x2="23.810747142857142" y1="475.609756097561"
											y2="475.609756097561" stroke="orange" fill="orange" stroke-width="3pt"
											style="stroke:orange;fill:orange;stroke-width:3pt"/>
									</g>
								</g>
							</g>
						</svg>
					</imagedata>
				</imageobject>
			</mediaobject>
		</figure>
		<para>Note that when we are using these substring preconditions, there is little we can do to
				<quote>pre-evaluate</quote> the patterns themselves. Just because
				<code>contains(.,'abc')</code> is a precondition for <code>contains(.,'abcdef')</code>, does
			not of course imply <code>contains(.,'def')</code> is now sufficent, unlike in other cases
			where a <quote>true</quote> condition reduces the expression.</para>
		<para>Now of course in this example there is some implicit structure in the class token using
			the solidus (<code>/</code>)<footnote>
				<para>It denotes DITA element equivalence to a given base element within a given
					topic.</para>
			</footnote>. Unfortunately this insight gains us little - using the substring before we get 14
			groups, using the substring after we get 197! Obviously a better approach is to use a more
			infomation-theoretic partitioning. For example 121 template rules match a class substring
				<code>' topic/...</code> but adding one more character to the discriminant for this case
			replaces this group with 19 subgroups, the largest being 12-15 in size.</para>
		<para>There is nothing that says we are restricted to initial substrings. Choosing the last 3
			characters (which of course end with a space) gives us 53 different preconditions, with the
			largest group being 19 in size. The effect is similar, as is shown in <xref
				linkend="fig.substring"/>.</para>
		<para>A recursive approach (extending the length of the substring for a particular group until
			subsequent subgroups are smaller than a proportion of the size of the original set or some
			minimum size) can give us a suitable partitioning. Doing this for this for 5% or a minimum of
			30 gives us 41 preconditions, with a largest reference group of 26. A general rule of thumb
			suggests that when the number of groups is similar to the size of each group, the testing
			workload should be minimised.</para>
		<para>On a more information-theoretic basis, we could generate some optimal partioning tree.
			However we have an issue that currently this would be done at compile-time, when, whilst we
			know the frequency of pattern components spread across the template spaces, we don't know the
			relative frequencies of execution on documents at run time. A possibility might be to collect
			statistics from representative training runs, which are then used to tune a subsequent compilation<footnote>
				<para>XSLT's package delivery mechanism might be a useful aid to this.</para>
			</footnote>.</para>
		<para>The performance figures above use Saxon's default rule list representation with
			precondition references added to the rules. Another possibility is to split the rule list into
			a number of separate lists where within each sublist rules which would
				<emphasis>fail</emphasis> a common precondition have been eliminated, then choose between
			the different lists at search start, based on checking a small number of those preconditions.
			For example, consider the two most frequent preconditions in <xref
				linkend="fig.substring2.pre"/> – <code>@C{ t}</code>, which qualifies 146 of the 240 rules
			and <code>@C{ p}</code> which qualifies 30. Satisfying the first condition does not restrict
			matches to just those rules which have that precondition; given the nature of the
				<code>contains()</code> function (and DITA's possibility of multiple class tag values) it
			would be entirely possible for one of the rules having the second precondition to match also.
			Rather the <emphasis>failure</emphasis> of <code>@C{ t}</code> rules out all those 146 rules,
			leaving a list of just 94 to be checked.</para>
		<para>So now we have to look at the inverse of the problem. <xref
				linkend="table.frequent.patterns"/> shows that just six patterns, all predicated on
				<code>@C{ t}</code>, account for at least 56% of all the template matches. Hence failure of
			this condition (which as we've seen limits the rules to be checked to 94) would only be
			invoked for a maximum of 45% of all calls. Failing <code>@C{ p}</code> will be frequent of
			course (for 70% of the elements), but it only eliminates 30 rules, albeit at high rank
			order.</para>
	</sect1>
	<sect1>
		<title>Other possibilities</title>
		<para>Using preconditions, as described above, does not change the correctness of the stylesheet
			behaviour under any circumstances. However, if the stylesheet designer can make certain
			guarantees about the overall stylesheet operation, then there are a number of other
			possibilities we might consider</para>

		<sect2 xml:id="rule.ambiguity">
			<title>
				<quote>Un-disambiguating</quote> rules</title>
			<para>We have noticed that in the execution of this stylesheet on the example source document,
				there actually is no ambiguity in applicable rules – all template patterns for a given
				precedence/priority rank have mutually exclusive patterns <emphasis>on the nodes present in
					the example DITA document</emphasis>. Hence we can assume that once a pattern for a
				template matches, all others of similar rank can be discarded. In effect we are suspending
				the checking of rule ambiguity, and provided that the mutual exclusivity is true for all
				practical purposes, which cannot be determined statically, the stylesheet will still
				continue to function correctly.</para>
			<para>In our example, where there are many templates sharing the same rank (e.g. the 78 of
				rank 9, or 25 of rank 5) we can eliminate further search to <quote>rank end</quote>. The
				effect may be slight but can be worth exploring. For our example we get the
				following:</para>
			<figure>
				<title>Effect of removing rule ambiguity</title>
				<mediaobject>
					<imageobject>
						<imagedata xmlns:xlink="http://www.w3.org/1999/xlink">
							<svg xmlns="http://www.w3.org/2000/svg" xmlns:db="http://docbook.org/ns/docbook"
								width="100%" height="100%" viewBox="0 0 1100 575">
								<desc/>
								<text x="20" y="20" font-size="10">2015-04-20T15:28:36.076+01:00</text>
								<g alignment-baseline="baseline" transform="translate(40,40)">
									<g>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="0" x2="0"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="0"
											>0</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="142.85714285714286"
											x2="142.85714285714286"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="285.7142857142857"
											x2="285.7142857142857"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="428.57142857142856"
											x2="428.57142857142856"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="571.4285714285714"
											x2="571.4285714285714"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="714.2857142857143"
											x2="714.2857142857143"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510"
											x="714.2857142857143">500</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="857.1428571428571"
											x2="857.1428571428571"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="1000" x2="1000"/>
										<text x="500" y="520" class="axis label" text-anchor="middle"
											font-family="arial" font-weight="bold" font-size="12pt"
											style="font-family:arial;font-weight:bold;font-size:12pt">Total / ms</text>
									</g>
									<g transform="translate(500,250)">
										<text class="label" x="0" y="20" font-family="arial" font-weight="bold"
											font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
											>Longest processed templates</text>
										<text class="label" x="0" y="40" font-family="arial" font-weight="bold"
											font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
											>mode:#default</text>
									</g>
									<svg x="800" y="60">
										<circle cx="5" cy="12" r="5" class="OFF" stroke="red" fill="red"
											style="stroke:red;fill:red"/>
										<text x="20" y="20" class="key label" font-family="arial" font-weight="bold"
											font-size="12pt" style="font-family:arial;font-weight:bold;font-size:12pt"
											>Normal</text>
										<circle cx="5" cy="32" r="5" class="SILENT" stroke="orange" fill="orange"
											style="stroke:orange;fill:orange"/>
										<text x="20" y="40" class="key label" font-family="arial" font-weight="bold"
											font-size="12pt" style="font-family:arial;font-weight:bold;font-size:12pt"
											>Silent</text>
									</svg>
									<g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="6.097560975609724"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">204:5 → @C{
												topic/tbody }/@C{ topic/row }/@C{ topic/entry }</text>
											<line class="OFF total" x1="0" x2="878.6806825" y1="12.195121951219505"
												y2="12.195121951219505" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="SILENT total" x1="0" x2="785.5486407142857"
												y1="18.292682926829286" y2="18.292682926829286" stroke="orange"
												fill="orange" stroke-width="3pt"
												style="stroke:orange;fill:orange;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="54.8780487804878"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">52:26 → @C{
												pr-d/codeph }</text>
											<line class="OFF total" x1="0" x2="297.9443275" y1="60.97560975609758"
												y2="60.97560975609758" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="SILENT total" x1="0" x2="275.8556803571429"
												y1="67.07317073170731" y2="67.07317073170731" stroke="orange" fill="orange"
												stroke-width="3pt" style="stroke:orange;fill:orange;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="103.65853658536582"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">151:9 → @C{ topic/p
												}</text>
											<line class="OFF total" x1="0" x2="279.14133964285713" y1="109.7560975609756"
												y2="109.7560975609756" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="SILENT total" x1="0" x2="202.6731460714286"
												y1="115.85365853658539" y2="115.85365853658539" stroke="orange"
												fill="orange" stroke-width="3pt"
												style="stroke:orange;fill:orange;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="152.4390243902439"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">199:5 → @C{
												topic/strow }/@C{ topic/stentry }</text>
											<line class="OFF total" x1="0" x2="277.9851857142857" y1="158.53658536585363"
												y2="158.53658536585363" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="SILENT total" x1="0" x2="229.84814607142857"
												y1="164.6341463414634" y2="164.6341463414634" stroke="orange" fill="orange"
												stroke-width="3pt" style="stroke:orange;fill:orange;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="201.21951219512192"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">206:5 → @C{
												topic/tbody }/@C{ topic/row }</text>
											<line class="OFF total" x1="0" x2="184.17469285714287" y1="207.3170731707317"
												y2="207.3170731707317" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="SILENT total" x1="0" x2="168.81524714285715"
												y1="213.41463414634148" y2="213.41463414634148" stroke="orange"
												fill="orange" stroke-width="3pt"
												style="stroke:orange;fill:orange;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="250" font-family="arial"
												font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">210:5 → @C{
												topic/colspec }</text>
											<line class="OFF total" x1="0" x2="183.33999035714285" y1="256.0975609756098"
												y2="256.0975609756098" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="SILENT total" x1="0" x2="167.056945" y1="262.1951219512195"
												y2="262.1951219512195" stroke="orange" fill="orange" stroke-width="3pt"
												style="stroke:orange;fill:orange;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="298.780487804878"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">205:5 → @C{
												topic/thead }/@C{ topic/row }/@C{ topic/entry }</text>
											<line class="OFF total" x1="0" x2="182.9328492857143" y1="304.8780487804878"
												y2="304.8780487804878" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="SILENT total" x1="0" x2="163.64892571428572"
												y1="310.9756097560976" y2="310.9756097560976" stroke="orange" fill="orange"
												stroke-width="3pt" style="stroke:orange;fill:orange;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="347.5609756097561"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">201:5 → @C{
												topic/strow }</text>
											<line class="OFF total" x1="0" x2="138.33878" y1="353.6585365853658"
												y2="353.6585365853658" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="SILENT total" x1="0" x2="114.5656067857143"
												y1="359.7560975609756" y2="359.7560975609756" stroke="orange" fill="orange"
												stroke-width="3pt" style="stroke:orange;fill:orange;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="396.3414634146342"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">213:5 → @C{
												topic/table }</text>
											<line class="OFF total" x1="0" x2="41.56523607142857" y1="402.4390243902439"
												y2="402.4390243902439" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="SILENT total" x1="0" x2="38.50893214285714"
												y1="408.5365853658536" y2="408.5365853658536" stroke="orange" fill="orange"
												stroke-width="3pt" style="stroke:orange;fill:orange;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="445.1219512195122"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">207:5 → @C{
												topic/thead }/@C{ topic/row }</text>
											<line class="OFF total" x1="0" x2="40.27045535714286" y1="451.219512195122"
												y2="451.219512195122" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="SILENT total" x1="0" x2="33.80200392857143"
												y1="457.3170731707317" y2="457.3170731707317" stroke="orange" fill="orange"
												stroke-width="3pt" style="stroke:orange;fill:orange;stroke-width:3pt"/>
										</g>
									</g>
								</g>
							</svg>
						</imagedata>
						<!-- <imagedata width="10cm" depth="7cm"
                            fileref="../../../tests/john/dita/ATests/svg/silent/modes/saxon-defaultMode/time.svg"
                            format="SVG"/>-->
					</imageobject>
				</mediaobject>
			</figure>
			<para>The effects are most marked on rules #151, where the number of rank 9 rules to be tested
				drops from 78 to 31 (total rules checked 198 → 151) and #204, where only 5 of the rank 5
				rules need checking, as against 25 (total rules checked 225 → 204). Interestingly, as we
				might expect, rule #52 (which is the most frequently called) gains no benefit, as it is the
				last member of rank 26 as shown in <xref linkend="rank.use"/>.</para>
			<para>We might also speculate on the effect if the 38 rules of rank 26 are re-ordered so that
				rule #52 is tested <emphasis>first</emphasis> and hence the number of rules checked for such
				nodes drops 52 → 16, suggesting time taken might drop to a third of its previous level. This
				would of course be predicated on user-provided guarantees of mutually exclusive
				applicability of rules<footnote>
					<para>We would be interested in situations within DITA-OT where there might be some
						expectation of non-exclusive rules at the same import precedence being written.</para>
				</footnote>. In the case of rule #52 simple movement of the template from the beginning to
				the end of its source file might have similar effect! </para>
			<para>In a similar manner for rule #204, it is imported through the <code>tables.xsl</code>
				stylesheet, whose position is circled in blue in <xref linkend="DITA.import"/>. If these
				importations are mutually exclusive, and they may well be, moving the importation of that
				file to the <emphasis>end</emphasis> of the importation list in its parent stylesheet
				increases the precedence of its templates and hence rank. The orange circled stylesheet
				contains rule #52. Such rearrangement of source declaration orders may be possible by
				collecting statistics from representative training runs to detect such conditions.</para>
			<para>Within XSLT2.0 it is an implementation choice as to whether conflict raises an error or
				the last applicable rule in declaration order is chosen. In Saxon, when warnings are silent,
				the last is always chosen regardless, other rules not being checked. In XSLT3.0 (which this
				DITA framework predates) this behaviour can be controlled by a
					<code>@on-multiple-match="use-last|fail"</code> property on a suitable <link
					xmlns:xlink="http://www.w3.org/1999/xlink"
					xlink:href="http://www.w3.org/TR/xslt-30/#element-mode">
					<code>xsl:mode</code>
				</link> declaration and issuing of warnings (which imply other rules must be checked)
				similarly.</para>
		</sect2>
		<sect2>
			<title>Pretokenizing</title>
			<para>The DITA architecture is effectively embedding structure (multiple class membership)
				within the <code>@class</code> attribute. If we can be guaranteed that this is the case,
				then an option might be to generate preconditions that operate on those implicit tokens
				whilst tokenising the appropriate accessor once for each node. So for example
					<code>*[contains(@class,' topic/entry ')]</code> would be considered equivalent to the
				pattern <code>*[tokenize(@class,'\s+') = 'topic/entry')]</code>
				<footnote>
					<para>It is only guaranteed equivalent if the <code>@class</code> value string starts and
						finishes with at least a single space.</para>
				</footnote> which can then be further converted into a pair:
				<programlisting>$tokens.class := tokenize(@class,'\s+')   
         →  ('foo','topic/entry')
test:
   $tokens.class = 'topic/entry'</programlisting>where
				the node would be tokenized exactly once for each containment-tested attribute (when the
				condition is first required) and then need only be tested for value membership against the
				token set in further rules examining the same attribute properties. In most cases the
					<code>@class</code> attribute contains three tags (of which the first is either
					'<code>+</code>' or '<code>-</code>' which is never tested by templates, at least in the
				current test, so the string literal sequences to be tested are very short.</para>
			<para>Now we define these tests as specialist tokenisation preconditions (they may of course
				be shared between rules) and index into the collection from the rules. And unlike with the
				substrings, we <emphasis>can</emphasis> project the effect of a true precondition into the
				pattern viz:
				<programlisting>R1: *[contains(@class,' topic/entry ')]
R2: *[contains(@class,' topic/row ')]
R3: *[contains(@class,' topic/row ')]/
       *[contains(@class,' topic/entry ')]   
→
R1: *[tokenize(@class,'\s+') = 'topic/entry')]
R2: *[tokenize(@class,'\s+') = 'topic/row')]
R3: *[tokenize(@class,'\s+') = 'topic/row')]/
       *[tokenize(@class,'\s+') = 'topic/entry')]
→
$tokens.class := 
    tokenize(@class,'\s+')
$tokens.parent.class := 
    tokenize(parent::*/@class,'\s+') 
$preconditionM := $tokens.class = 'topic/entry'
$preconditionN := $tokens.class = 'topic/row'
$preconditionP := $tokens.parent.class = 'topic/row'

R1:  $preconditionM &amp;&amp; *
R2:  $preconditionN &amp;&amp; *
R3:  $preconditionP &amp;&amp; $preconditionM &amp;&amp; * </programlisting>where
				the token variables and precondition references are held within the rule-processing
				structure. Within Saxon these element match rules (<code>*</code>) would be indexed on the
					<quote>unnamed element</quote> list, so the last part of each of the final rule patterns
				would always yield true. In this case these rules have been reduced to just a conjunction of
				their preconditions.</para>
			<para>The preconditions only call for the appropriate tokenisation when it is first needed
				(they are effectively single-assignment local variables with a scope for the pattern match
				for a single node, and evaluated lazily) – so that other preconditions involving differing
				values only need to check within their own sequence comparison. Obviously for a predicate
				which already uses explicit tokenisation mechanisms (such as processing semicolon-separated
					<code>@style</code> descriptions on SVG and the like) then this technique can be used
				similarly. For our example document, we get the following performance improvements:</para>
			<figure>
				<title>Effect of pre-tokenizing pattern test inputs</title>
				<mediaobject>
					<imageobject>
						<imagedata xmlns:xlink="http://www.w3.org/1999/xlink">
							<svg xmlns="http://www.w3.org/2000/svg" xmlns:db="http://docbook.org/ns/docbook"
								width="100%" height="100%" viewBox="0 0 1100 575">
								<desc/>
								<text x="20" y="20" font-size="10">2015-04-18T14:06:32.352+01:00</text>
								<g alignment-baseline="baseline" transform="translate(40,40)">
									<g>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="0" x2="0"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510" x="0"
											>0</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="142.85714285714286"
											x2="142.85714285714286"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="285.7142857142857"
											x2="285.7142857142857"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="428.57142857142856"
											x2="428.57142857142856"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="571.4285714285714"
											x2="571.4285714285714"/>
										<line stroke="grey" stroke-width="1" y1="0" y2="500" x1="714.2857142857143"
											x2="714.2857142857143"/>
										<text class="axis value" text-anchor="middle" font-size="10" y="510"
											x="714.2857142857143">500</text>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="857.1428571428571"
											x2="857.1428571428571"/>
										<line stroke="grey" stroke-width="0.5" y1="0" y2="500" x1="1000" x2="1000"/>
										<text x="500" y="520" class="axis label" text-anchor="middle"
											font-family="arial" font-weight="bold" font-size="12pt"
											style="font-family:arial;font-weight:bold;font-size:12pt">Total / ms</text>
									</g>
									<g transform="translate(500,250)">
										<text class="label" x="0" y="20" font-family="arial" font-weight="bold"
											font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
											>Longest processed templates</text>
										<text class="label" x="0" y="40" font-family="arial" font-weight="bold"
											font-size="15pt" style="font-family:arial;font-weight:bold;font-size:15pt"
											>mode:#default</text>
									</g>
									<svg x="800" y="60">
										<circle cx="5" cy="12" r="5" class="OFF" stroke="red" fill="red"
											style="stroke:red;fill:red"/>
										<text x="20" y="20" class="key label" font-family="arial" font-weight="bold"
											font-size="12pt" style="font-family:arial;font-weight:bold;font-size:12pt"
											>Normal</text>
										<circle cx="5" cy="32" r="5" class="TOKEN" stroke="green" fill="green"
											style="stroke:green;fill:green"/>
										<text x="20" y="40" class="key label" font-family="arial" font-weight="bold"
											font-size="12pt" style="font-family:arial;font-weight:bold;font-size:12pt"
											>Tokenized patterns</text>
									</svg>
									<g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="6.097560975609724"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">204:5 → @C{
												topic/tbody }/@C{ topic/row }/@C{ topic/entry }</text>
											<line class="OFF total" x1="0" x2="999.4050178571429" y1="12.195121951219505"
												y2="12.195121951219505" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="TOKEN total" x1="0" x2="601.3965239285715"
												y1="18.292682926829286" y2="18.292682926829286" stroke="green" fill="green"
												stroke-width="3pt" style="stroke:green;fill:green;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="54.8780487804878"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">52:26 → @C{
												pr-d/codeph }</text>
											<line class="OFF total" x1="0" x2="315.34654" y1="60.97560975609758"
												y2="60.97560975609758" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="TOKEN total" x1="0" x2="263.04141392857144"
												y1="67.07317073170731" y2="67.07317073170731" stroke="green" fill="green"
												stroke-width="3pt" style="stroke:green;fill:green;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="103.65853658536582"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">199:5 → @C{
												topic/strow }/@C{ topic/stentry }</text>
											<line class="OFF total" x1="0" x2="303.93577321428575" y1="109.7560975609756"
												y2="109.7560975609756" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="TOKEN total" x1="0" x2="183.8544342857143"
												y1="115.85365853658539" y2="115.85365853658539" stroke="green" fill="green"
												stroke-width="3pt" style="stroke:green;fill:green;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="152.4390243902439"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">151:9 → @C{ topic/p
												}</text>
											<line class="OFF total" x1="0" x2="294.64198785714285" y1="158.53658536585363"
												y2="158.53658536585363" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="TOKEN total" x1="0" x2="165.07308035714286"
												y1="164.6341463414634" y2="164.6341463414634" stroke="green" fill="green"
												stroke-width="3pt" style="stroke:green;fill:green;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="201.21951219512192"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">206:5 → @C{
												topic/tbody }/@C{ topic/row }</text>
											<line class="OFF total" x1="0" x2="208.6947667857143" y1="207.3170731707317"
												y2="207.3170731707317" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="TOKEN total" x1="0" x2="126.70043857142858"
												y1="213.41463414634148" y2="213.41463414634148" stroke="green" fill="green"
												stroke-width="3pt" style="stroke:green;fill:green;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="250" font-family="arial"
												font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">210:5 → @C{
												topic/colspec }</text>
											<line class="OFF total" x1="0" x2="205.6521417857143" y1="256.0975609756098"
												y2="256.0975609756098" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="TOKEN total" x1="0" x2="125.36115321428572"
												y1="262.1951219512195" y2="262.1951219512195" stroke="green" fill="green"
												stroke-width="3pt" style="stroke:green;fill:green;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="298.780487804878"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">205:5 → @C{
												topic/thead }/@C{ topic/row }/@C{ topic/entry }</text>
											<line class="OFF total" x1="0" x2="205.56047892857143" y1="304.8780487804878"
												y2="304.8780487804878" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="TOKEN total" x1="0" x2="124.07182285714286"
												y1="310.9756097560976" y2="310.9756097560976" stroke="green" fill="green"
												stroke-width="3pt" style="stroke:green;fill:green;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="347.5609756097561"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">201:5 → @C{
												topic/strow }</text>
											<line class="OFF total" x1="0" x2="147.87364357142857" y1="353.6585365853658"
												y2="353.6585365853658" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="TOKEN total" x1="0" x2="94.51161" y1="359.7560975609756"
												y2="359.7560975609756" stroke="green" fill="green" stroke-width="3pt"
												style="stroke:green;fill:green;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="396.3414634146342"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">213:5 → @C{
												topic/table }</text>
											<line class="OFF total" x1="0" x2="46.33174785714286" y1="402.4390243902439"
												y2="402.4390243902439" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="TOKEN total" x1="0" x2="33.050132142857144"
												y1="408.5365853658536" y2="408.5365853658536" stroke="green" fill="green"
												stroke-width="3pt" style="stroke:green;fill:green;stroke-width:3pt"/>
										</g>
										<g>
											<text class="match" x="0.0000028571428571428573" y="445.1219512195122"
												font-family="arial" font-size="9pt" font-weight="bold"
												style="font-family:arial;font-size:9pt;font-weight:bold">211:5 → @C{
												topic/tgroup }</text>
											<line class="OFF total" x1="0" x2="44.72118785714286" y1="451.219512195122"
												y2="451.219512195122" stroke="red" fill="red" stroke-width="3pt"
												style="stroke:red;fill:red;stroke-width:3pt"/>
											<line class="TOKEN total" x1="0" x2="26.367928214285715"
												y1="457.3170731707317" y2="457.3170731707317" stroke="green" fill="green"
												stroke-width="3pt" style="stroke:green;fill:green;stroke-width:3pt"/>
										</g>
									</g>
								</g>
							</svg>
						</imagedata>
					</imageobject>
				</mediaobject>
			</figure>
			<para>The number of preconditions is now large (~200, corresponding to each possible tag value
				mentioned in the stylesheet) but most are referenced only once. However they all share a
				single tokenisation of the <code>@class</code> attribute (or that of the parent's in some
				cases)</para>
			<note>
				<para>A generalisation of this technique into evaluating and then crossreferring to common
					subexpressions is a possibility. In the case here the binding between preconditions and
					the evaluated variable is very tight (the variable value for a given node is merely a
					(small) finite list of strings). Extension to a more generic sequenced-value approach
					would probably be considerably more complex.</para>
			</note>
		</sect2>
		<sect2>
			<title>Using key() mechanisms</title>
			<para>From early on XSLT has defined a <code>key()</code> mechanism to speed searching for
				applicable nodes within an XML tree. Using the <code>xsl:key</code> declaration a set of
				nodes can be classified into a number of subsets dependent upon an expression evaluated for
				each node<footnote>
					<para>A node can be a member of several subsets, as the key determination can produce
						several values (e.g. <code>xsl:key match="car" use="@year,@colour"</code>).</para>
				</footnote>. Usually support for this within an XSLT implementation is efficient, the key
				being computed only once. Thus it is tempting to see whether a suitable set of keys can be
				generated and used within modified patterns. The approach is basically:
				<programlisting>*[contains(@attr,'string')] 
       → *[key('attr','string',.)[1] is .]</programlisting>
				where effectively the key has been defined by:</para>

			<programlisting language="xml">&lt;xsl:key name="attr" 
   select="*" 
   use="let $e := . return
    (string1, ... stringN)[contains($e/@attr,.)]"
/&gt;</programlisting>
			<para>The key has indexed all the nodes whose <code>@attr</code> contains any of the
				substrings mentioned within the templates, based on that substring. The pattern uses this
				key, subsetting the nodes to just those which are <code>descendant-or-self::*</code> of the
				element being tested – if the first node is the target node then there is a match.</para>
			<para>We implemented this scheme, but unsurprisingly rather than improve, matters deteriorate
				significantly. In computing the key (which Saxon does on the first request via the
					<function>key()</function> call) <emphasis>every</emphasis> document element is processed,
				for <emphasis>every possible contained substring</emphasis> mentioned in the template sets.
				Equally well, the predicated key lookup starting at a given node
					(<code>[key('attr','string',.)[1] is .]</code>) involves searching through all the
				document-ordered nodes already computed for the key (which in our case of course means
				pretty much all the elements in the entire document) to find the current focus. A moment's
				thought suggests that will have <emphasis>O(n<superscript>2</superscript>)</emphasis>
				performance. (If the templates were of the form <code>*[@attr='string']</code> a key
				approach might work – certainly <code>&lt;xsl:key name="attr" select="*"
					use="@attr"/&gt;</code> will be very much cheaper.)</para>
		</sect2>
	</sect1>
	<sect1>
		<title>Generalisation?</title>
		<para>In the introduction we mentioned both DITA and Docbook being significant large
			document-engineering frameworks. Our experimentation has focussed on DITA given the expensive
			nature of processing its class representation. We were curious to see if similar issues might
			appear in processing Docbook documents – we believe this not to be the case. A survey of one
			of the steps (conversion of Docbook into HTML<footnote>
				<para>
					<code>docbook/xsl/html/docbook_custom.xsl</code> in the Oxygen 16.1 implementation</para>
			</footnote>) which is of similar <quote>size</quote> to those within DITA-OT, shows that of
			the 1500 pattern matching templates within 59 files, only 113 are against unnamed elements or
			attributes, and none of the 190 modes has more than two. The vast majority of patterns are
			described for named elements and thus would be fully indexed within Saxon. Hence we anticipate
			the methods discussed in this paper would not be necessary for that framework.</para>
		<para>We have shown that extracting a set of preconditions, where evaluating one precondition
			for a particular node can eliminate many match patterns, is an effective strategy for the DITA
			stylesheets we have been studying. This then raises the next question: can the technique be
			generalized so that it is suitable for inclusion in a general-purpose XSLT processor,
			producing performance benefits for a sufficiently large set of stylesheets to justify its
			existence?</para>
		<para>This divides into two sub-questions: firstly, is the general strategy of extracting
			preconditions general-purpose enough? We think it is. Secondly, what about the specific rules
			that we have found to work well on the DITA stylesheets? Here, we are not convinced – they are
			intimately tied up with the way DITA-OT decomposes the class representation tags.</para>
		<para>We believe that for the same general approach to work with different kinds of stylesheets,
			we may need to make the rules for extracting preconditions in some way configurable. So we
			might consider shipping the product with a set of rules that work well for DITA, and other
			sets of rules that work well for other XML vocabularies. We could consider defining a
			vocabulary allowing the rules to be written declaratively [see John Snelson's paper on
			declarative XQuery rewrite rules <xref linkend="Snelson.2011"/> for some possibilities. The
			designers of an XML vocabulary could then perhaps ship a Saxon optimizer plug-in that applies
			rules appropriate to the specific vocabulary. Saxon could perhaps select an appropriate
			plug-in from the repertoire available based on the namespaces in use in the particular
			stylesheet. </para>
	</sect1>
	<sect1>
		<title>Conclusions</title>
		<para>In this paper we have examined performance issues in processing a relatively large
			document with an XSLT transform containing a large number of generic templates whose match
			computation can be expensive, and where large numbers of pattern matches occur very late in
				<quote>rank order</quote>. We've shown that by choosing suitable shared preconditions for
			rules, which need only be computed once for a node under test, we can ameliorate the effect of
			such long rank sequences in pattern sets. Alternatively, by choosing to add some
				<quote>higher-level</quote> knowledge, declaring that a given set of patterns is in effect
			implementing a tokenisation, we can also improve pattern matching.</para>
		<para>As implementors of a major XSLT processor, our next step is to examine ways that such
			heuristics can be added and configured in the product. Some of these may be very specific
			declarations within a configuration. Others might be associated with running training sets,
			collecting statistics and proposing specific tunings. Watch this space...</para>
	</sect1>
	<acknowledgements>
		<para>Saxonica would like to thank its (anonymous) client who was very willing to let us study
			the processing of one of his real DITA documents in detail. Hopefully we'll be able to repay
			him soon with some welcome <quote>tune-up</quote>.</para>
	</acknowledgements>
	<bibliography>
		<title>References</title>

		<biblioentry xml:id="Kay.2005">
			<abbrev>1</abbrev>
			<authorgroup>
				<author>
					<personname>
						<firstname>Michael</firstname>
						<surname>Kay</surname>
					</personname>
				</author>
			</authorgroup>
			<title>Saxon: Anatomy of an XSLT processor</title>
			<date>2005</date>
			<biblioid class="uri">http://www.ibm.com/developerworks/library/x-xslt2/</biblioid>
		</biblioentry>
		<biblioentry xml:id="Kay.2007">
			<abbrev>2</abbrev>
			<authorgroup>
				<author>
					<personname>
						<firstname>Michael</firstname>
						<surname>Kay</surname>
					</personname>
				</author>
			</authorgroup>
			<title>Writing an XSLT Optimizer in XSLT</title>
			<publishername>Extreme Markup Languages</publishername>
			<date>2007</date>
			<biblioid class="uri"
				>http://conferences.idealliance.org/extreme/html/2007/Kay01/EML2007Kay01.html</biblioid>
		</biblioentry>
		<biblioentry xml:id="Kay.2014">
			<abbrev>3</abbrev>
			<authorgroup>
				<author>
					<personname>
						<firstname>Michael</firstname>
						<surname>Kay</surname>
					</personname>
				</author>
				<author>
					<personname>
						<firstname>Debbie</firstname>
						<surname>Lockett</surname>
					</personname>
				</author>
			</authorgroup>
			<title>Benchmarking XSLT Performance</title>
			<date>2014</date>
			<biblioid class="doi">10.14337/XMLLondon14.Kay01</biblioid>
		</biblioentry>
		<biblioentry xml:id="Snelson.2011">
			<abbrev>4</abbrev>
			<authorgroup>
				<author>
					<personname>
						<firstname>John</firstname>
						<surname>Snelson</surname>
					</personname>
				</author>
			</authorgroup>
			<title>Declarative XQuery Rewrites for Profit or Pleasure</title>
			<date>2011</date>
			<pagenums>211-225</pagenums>
			<biblioid class="uri"
				>http://archive.xmlprague.cz/2011/files/xmlprague-2011-proceedings.pdf#page=225</biblioid>
		</biblioentry>
		<biblioentry xml:id="XSLT">
			<abbrev>5</abbrev>
			<title>XSL Transformations (XSLT) Version 3.0</title>
			<date>2014</date>
			<publishername>World Wide Web Consortium (W3C)</publishername>
			<biblioid class="uri">http://www.w3.org/TR/xslt-30/</biblioid>
		</biblioentry>

	</bibliography>
</article>
